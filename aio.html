<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Introduction to Geospatial Raster and Vector Data with R for COBALT: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav data"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Data Carpentry" src="assets/images/data-logo.svg">
</div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav data" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Data Carpentry" src="assets/images/data-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Introduction to Geospatial Raster and Vector Data with R for COBALT
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Introduction to Geospatial Raster and Vector Data with R for COBALT
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="discuss.html">Discussion</a></li>
<li><a class="dropdown-item" href="reference.html"></a></li>
          </ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to Geospatial Raster and Vector Data with R for COBALT
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress data">
    <div class="progress-bar data" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-raster-structure.html">1. Intro to Raster Data</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-raster-plot.html">2. Plot Raster Data</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="06-vector-open-shapefile-in-r.html">3. Open and Plot Vector Layers</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="07-vector-shapefile-attributes-in-r.html">4. Explore and Plot by Vector Layer Attributes</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="08-vector-plot-shapefiles-custom-legend.html">5. Plot Multiple Vector Layers</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="09-vector-when-data-dont-line-up-crs.html">6. Handling Spatial Projection &amp; CRS</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="10-vector-csv-to-shapefile-in-r.html">7. Convert from .csv to a Vector Layer</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="11-vector-raster-integration.html">8. Extracting Data from Rasters using Vectors</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="05-raster-multi-band-in-r.html">9. Work with Multi-Band Rasters</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="04-raster-calculations-in-r.html">10. Raster Calculations</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="discuss.html">Discussion</a></li>
<li><a href="reference.html"></a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-raster-structure"><p>Content from <a href="01-raster-structure.html">Intro to Raster Data</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/01-raster-structure.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>phantomjs has been installed to /home/runner/bin</code></pre>
</div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is a raster dataset?</li>
<li>How do I work with and plot raster data in R?</li>
<li>How can I handle missing or bad data values for a raster?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Describe the fundamental attributes of a raster dataset.</li>
<li>Explore raster attributes and metadata using R.</li>
<li>Import rasters into R using the <code>terra</code> package.</li>
<li>Plot a raster file in R using the <code>ggplot2</code> package.</li>
<li>Describe the difference between single- and multi-band rasters.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>In this episode, we will introduce the fundamental principles,
packages and metadata/raster attributes that are needed to work with
raster data in R. We will discuss some of the core metadata elements
that we need to understand to work with rasters in R, including CRS and
resolution. We will also explore missing and bad data values as stored
in a raster and how R handles these elements.</p>
<p>We will continue to work with the <code>dplyr</code> and
<code>ggplot2</code> packages that were introduced in the <a href="https://cobalt-casco.github.io/r-intro-geospatial/" class="external-link">Introduction
to R for Geospatial Data</a> lesson. We will use two additional packages
in this episode to work with raster data - the <code>terra</code> and
<code>sf</code> packages. Make sure that you have these packages
loaded.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyterra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span></code></pre>
</div>
<div id="introduce-the-data" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="introduce-the-data" class="callout-inner">
<h3 class="callout-title">Introduce the Data<a class="anchor" aria-label="anchor" href="#introduce-the-data"></a>
</h3>
<div class="callout-content">
<p>If not already discussed, introduce the datasets that will be used in
this lesson. A brief introduction to the datasets can be found on the <a href="https://cobalt-casco.github.io/geospatial-workshop/#data" class="external-link">Geospatial
workshop homepage</a>.</p>
<p>For more detailed information about the datasets, check out the <a href="https://cobalt-casco.github.io/geospatial-workshop/data/" class="external-link">Geospatial
workshop data page</a>.</p>
</div>
</div>
</div>
<section id="view-raster-file-attributes"><h2 class="section-heading">View Raster File Attributes<a class="anchor" aria-label="anchor" href="#view-raster-file-attributes"></a>
</h2>
<hr class="half-width">
<p>We will be working with a series of GeoTIFF files in this lesson. The
GeoTIFF format contains a set of embedded tags with metadata about the
raster data. We can use the function <code>describe()</code> to get
information about our raster data before we read that data into R. It is
ideal to do this before importing your data.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/landsat_casco/b10_cropped/LC09_L2SP_011030_20230920_20230922_02_T1_ST_B10.TIF"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"                                                                                                                                                                                                                                                                                                                          
 [2] "Files: data/landsat_casco/b10_cropped/LC09_L2SP_011030_20230920_20230922_02_T1_ST_B10.TIF"                                                                                                                                                                                                                                                      
 [3] "Size is 1128, 1349"                                                                                                                                                                                                                                                                                                                             
 [4] "Coordinate System is:"                                                                                                                                                                                                                                                                                                                          
 [5] "PROJCRS[\"WGS 84 / UTM zone 19N\","                                                                                                                                                                                                                                                                                                             
 [6] "    BASEGEOGCRS[\"WGS 84\","                                                                                                                                                                                                                                                                                                                    
 [7] "        DATUM[\"World Geodetic System 1984\","                                                                                                                                                                                                                                                                                                  
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"                                                                                                                                                                                                                                                                                        
 [9] "                LENGTHUNIT[\"metre\",1]]],"                                                                                                                                                                                                                                                                                                     
[10] "        PRIMEM[\"Greenwich\",0,"                                                                                                                                                                                                                                                                                                                
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"                                                                                                                                                                                                                                                                                         
[12] "        ID[\"EPSG\",4326]],"                                                                                                                                                                                                                                                                                                                    
[13] "    CONVERSION[\"UTM zone 19N\","                                                                                                                                                                                                                                                                                                               
[14] "        METHOD[\"Transverse Mercator\","                                                                                                                                                                                                                                                                                                        
[15] "            ID[\"EPSG\",9807]],"                                                                                                                                                                                                                                                                                                                
[16] "        PARAMETER[\"Latitude of natural origin\",0,"                                                                                                                                                                                                                                                                                            
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"                                                                                                                                                                                                                                                                                          
[18] "            ID[\"EPSG\",8801]],"                                                                                                                                                                                                                                                                                                                
[19] "        PARAMETER[\"Longitude of natural origin\",-69,"                                                                                                                                                                                                                                                                                         
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"                                                                                                                                                                                                                                                                                          
[21] "            ID[\"EPSG\",8802]],"                                                                                                                                                                                                                                                                                                                
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"                                                                                                                                                                                                                                                                                   
[23] "            SCALEUNIT[\"unity\",1],"                                                                                                                                                                                                                                                                                                            
[24] "            ID[\"EPSG\",8805]],"                                                                                                                                                                                                                                                                                                                
[25] "        PARAMETER[\"False easting\",500000,"                                                                                                                                                                                                                                                                                                    
[26] "            LENGTHUNIT[\"metre\",1],"                                                                                                                                                                                                                                                                                                           
[27] "            ID[\"EPSG\",8806]],"                                                                                                                                                                                                                                                                                                                
[28] "        PARAMETER[\"False northing\",0,"                                                                                                                                                                                                                                                                                                        
[29] "            LENGTHUNIT[\"metre\",1],"                                                                                                                                                                                                                                                                                                           
[30] "            ID[\"EPSG\",8807]]],"                                                                                                                                                                                                                                                                                                               
[31] "    CS[Cartesian,2],"                                                                                                                                                                                                                                                                                                                           
[32] "        AXIS[\"(E)\",east,"                                                                                                                                                                                                                                                                                                                     
[33] "            ORDER[1],"                                                                                                                                                                                                                                                                                                                          
[34] "            LENGTHUNIT[\"metre\",1]],"                                                                                                                                                                                                                                                                                                          
[35] "        AXIS[\"(N)\",north,"                                                                                                                                                                                                                                                                                                                    
[36] "            ORDER[2],"                                                                                                                                                                                                                                                                                                                          
[37] "            LENGTHUNIT[\"metre\",1]],"                                                                                                                                                                                                                                                                                                          
[38] "    USAGE["                                                                                                                                                                                                                                                                                                                                     
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"                                                                                                                                                                                                                                                                                   
[40] "        AREA[\"Between 72°W and 66°W, northern hemisphere between equator and 84°N, onshore and offshore. Aruba. Bahamas. Brazil. Canada - New Brunswick (NB); Labrador; Nunavut; Nova Scotia (NS); Quebec. Colombia. Dominican Republic. Greenland. Netherlands Antilles. Puerto Rico. Turks and Caicos Islands. United States. Venezuela.\"],"
[41] "        BBOX[0,-72,84,-66]],"                                                                                                                                                                                                                                                                                                                   
[42] "    ID[\"EPSG\",32619]]"                                                                                                                                                                                                                                                                                                                        
[43] "Data axis to CRS axis mapping: 1,2"                                                                                                                                                                                                                                                                                                             
[44] "Origin = (398865.000000000000000,4866405.000000000000000)"                                                                                                                                                                                                                                                                                      
[45] "Pixel Size = (30.000000000000000,-30.000000000000000)"                                                                                                                                                                                                                                                                                          
[46] "Metadata:"                                                                                                                                                                                                                                                                                                                                      
[47] "  AREA_OR_POINT=Area"                                                                                                                                                                                                                                                                                                                           
[48] "Image Structure Metadata:"                                                                                                                                                                                                                                                                                                                      
[49] "  COMPRESSION=LZW"                                                                                                                                                                                                                                                                                                                              
[50] "  INTERLEAVE=BAND"                                                                                                                                                                                                                                                                                                                              
[51] "Corner Coordinates:"                                                                                                                                                                                                                                                                                                                            
[52] "Upper Left  (  398865.000, 4866405.000) ( 70d15'36.90\"W, 43d56'37.75\"N)"                                                                                                                                                                                                                                                                      
[53] "Lower Left  (  398865.000, 4825935.000) ( 70d15' 9.45\"W, 43d34'46.27\"N)"                                                                                                                                                                                                                                                                      
[54] "Upper Right (  432705.000, 4866405.000) ( 69d50'19.04\"W, 43d56'51.69\"N)"                                                                                                                                                                                                                                                                      
[55] "Lower Right (  432705.000, 4825935.000) ( 69d50' 0.77\"W, 43d35' 0.04\"N)"                                                                                                                                                                                                                                                                      
[56] "Center      (  415785.000, 4846170.000) ( 70d 2'46.52\"W, 43d45'49.65\"N)"                                                                                                                                                                                                                                                                      
[57] "Band 1 Block=1128x1 Type=Float32, ColorInterp=Gray"                                                                                                                                                                                                                                                                                             
[58] "  Description = SST_F_20230920"                                                                                                                                                                                                                                                                                                                 
[59] "  Min=47.097 Max=80.462 "                                                                                                                                                                                                                                                                                                                       
[60] "  Minimum=47.097, Maximum=80.462, Mean=-9999.000, StdDev=-9999.000"                                                                                                                                                                                                                                                                             
[61] "  NoData Value=nan"                                                                                                                                                                                                                                                                                                                             
[62] "  Metadata:"                                                                                                                                                                                                                                                                                                                                    
[63] "    STATISTICS_MAXIMUM=80.461517333984"                                                                                                                                                                                                                                                                                                         
[64] "    STATISTICS_MEAN=-9999"                                                                                                                                                                                                                                                                                                                      
[65] "    STATISTICS_MINIMUM=47.096858978271"                                                                                                                                                                                                                                                                                                         
[66] "    STATISTICS_STDDEV=-9999"                                                                                                                                                                                                                                                                                                                    </code></pre>
</div>
<p>If you wish to store this information in R, you can do the
following:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">casco_b10_2023_info</span> <span class="op">&lt;-</span> <span class="fu">capture.output</span><span class="op">(</span></span>
<span>  <span class="fu">describe</span><span class="op">(</span><span class="st">"data/landsat_casco/b10_cropped/LC09_L2SP_011030_20230920_20230922_02_T1_ST_B10.TIF"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Each line of text that was printed to the console is now stored as an
element of the character vector <code>casco_b10_2023_info</code>. We
will be exploring this data throughout this episode. By the end of this
episode, you will be able to explain and understand the output
above.</p>
</section><section id="open-a-raster-in-r"><h2 class="section-heading">Open a Raster in R<a class="anchor" aria-label="anchor" href="#open-a-raster-in-r"></a>
</h2>
<hr class="half-width">
<p>Now that we’ve previewed the metadata for our GeoTIFF, let’s import
this raster dataset into R and explore its metadata more closely. We can
use the <code>rast()</code> function to open a raster in R.</p>
<div id="data-tip---object-names" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip---object-names" class="callout-inner">
<h3 class="callout-title">Data Tip - Object names<a class="anchor" aria-label="anchor" href="#data-tip---object-names"></a>
</h3>
<div class="callout-content">
<p>To improve code readability, file and object names should be used
that make it clear what is in the file. The data for this episode were
collected from Harvard Forest so we’ll use a naming convention of
<code>datatype_casco_2023</code>.</p>
</div>
</div>
</div>
<p>First we will load our raster file into R and view the data
structure.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2023</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/landsat_casco/b10_cropped/LC09_L2SP_011030_20230920_20230922_02_T1_ST_B10.TIF"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b10_casco_2023</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster 
dimensions  : 1349, 1128, 1  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 398865, 432705, 4825935, 4866405  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 19N (EPSG:32619) 
source      : LC09_L2SP_011030_20230920_20230922_02_T1_ST_B10.TIF 
name        : SST_F_20230920 
min value   :       47.09686 
max value   :       80.46152 </code></pre>
</div>
<p>The information above includes a report of min and max values, but no
other data range statistics. Similar to other R data structures like
vectors and data frame columns, descriptive statistics for raster data
can be retrieved like</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">summary</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: [summary] used a sample</code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> SST_F_20230920 
 Min.   :47.13  
 1st Qu.:60.04  
 Median :60.57  
 Mean   :60.97  
 3rd Qu.:61.63  
 Max.   :80.35  
 NA's   :50545  </code></pre>
</div>
<p>but note the warning - unless you force R to calculate these
statistics using every cell in the raster, it will take a random sample
of 100,000 cells and calculate from that instead. To force calculation
all the values, you can use the function <code>values</code>:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">summary</span><span class="op">(</span><span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> SST_F_20230920  
 Min.   :47.1    
 1st Qu.:60.0    
 Median :60.6    
 Mean   :61.0    
 3rd Qu.:61.6    
 Max.   :80.5    
 NA's   :766560  </code></pre>
</div>
<p>To visualise this data in R using <code>ggplot2</code>, we have two
options. First, We can convert it to a dataframe. We learned about
dataframes in <a href="https://cobalt-casco.github.io/r-intro-geospatial/04-data-structures-part2/index.html" class="external-link">an
earlier lesson</a>. The <code>terra</code> package has an built-in
function for conversion to a plotable dataframe.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2023_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">b10_casco_2023</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>Now when we view the structure of our data, we will see a standard
dataframe format.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">str</span><span class="op">(</span><span class="va">b10_casco_2023_df</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	755112 obs. of  3 variables:
 $ x             : num  428640 428670 428700 428730 428760 ...
 $ y             : num  4866390 4866390 4866390 4866390 4866390 ...
 $ SST_F_20230920: num  67.1 66.9 66.7 66.6 66.5 ...</code></pre>
</div>
<p>We can use <code>ggplot()</code> to plot this data. We will set the
color scale to <code>scale_fill_viridis_c</code> which is a
color-blindness friendly color scale. We will also use the
<code>coord_quickmap()</code> function to use an approximate Mercator
projection for our plots. This approximation is suitable for small areas
that are not too close to the poles. Other coordinate systems are
available in ggplot2 if needed, you can learn about them at their help
page <code>?coord_map</code>.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023_df</span>, </span>
<span>                <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                    fill <span class="op">=</span> <span class="va">SST_F_20230920</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: Raster pixels are placed at uneven horizontal intervals and will be shifted
ℹ Consider using `geom_tile()` instead.</code></pre>
</div>
<figure style="text-align: center"><img src="fig/01-raster-structure-rendered-ggplot-raster-1.png" alt="Raster plot with ggplot2 using the viridis color scale" class="figure mx-auto d-block"><figcaption>
Raster plot with ggplot2 using the viridis color scale
</figcaption></figure><p>This is somewhat tedious. With the <code>tidyterra</code> package we
have another geom - <code>geom_spatraster</code> that deals with rasters
loaded by <code>terra</code>. Also, as land is NA in this data, it will
plot it quite nicely by default. We’ll also use
<code>coord_sf()</code></p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023</span>, </span>
<span>                    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">SST_F_20230920</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;SpatRaster&gt; resampled to 500778 cells for plotting</code></pre>
</div>
<figure style="text-align: center"><img src="fig/01-raster-structure-rendered-ggplot-raster-tidyterra-1.png" alt="Raster plot with ggplot2 using the viridis color scale" class="figure mx-auto d-block"><figcaption>
Raster plot with ggplot2 using the viridis color scale
</figcaption></figure><p>This looks great, and is now on the lat/long scale: CRS 4326. That’s
because spatial data is always plotted using the <code>coord_sf()</code>
coordinate system which defaults to 4326. If we want to show things in
another projection, or use the original one, we have to set a
<code>datum</code> argument.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023</span>, </span>
<span>                    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">SST_F_20230920</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>datum <span class="op">=</span> <span class="fu">crs</span><span class="op">(</span><span class="va">b10_casco_2023</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;SpatRaster&gt; resampled to 500778 cells for plotting</code></pre>
</div>
<figure style="text-align: center"><img src="fig/01-raster-structure-rendered-ggplot-raster-tidyterra-crs-1.png" alt="Raster plot with ggplot2 using the viridis color scale on the original CRS" class="figure mx-auto d-block"><figcaption>
Raster plot with ggplot2 using the viridis color scale on the original
CRS
</figcaption></figure><div id="plotting-tip" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="plotting-tip" class="callout-inner">
<h3 class="callout-title">Plotting Tip<a class="anchor" aria-label="anchor" href="#plotting-tip"></a>
</h3>
<div class="callout-content">
<p>More information about the Viridis palette used above at <a href="https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html" class="external-link">R
Viridis package documentation</a>.</p>
</div>
</div>
</div>
<div id="plotting-tip-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plotting-tip-1" class="callout-inner">
<h3 class="callout-title">Plotting Tip<a class="anchor" aria-label="anchor" href="#plotting-tip-1"></a>
</h3>
<div class="callout-content">
<p>For faster, simpler plots, you can use the <code>plot</code> function
from the <code>terra</code> package.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show plot</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>See <code>?plot</code> for more arguments to customize the plot</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/01-raster-structure-rendered-unnamed-chunk-7-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<p>This map shows the elevation of our study site in Harvard Forest.
From the legend, we can see that the maximum elevation is ~400, but we
can’t tell whether this is 400 feet or 400 meters because the legend
doesn’t show us the units. We can look at the metadata of our object to
see what the units are. Much of the metadata that we’re interested in is
part of the CRS. We introduced the concept of a CRS in <a href="https://cobalt-casco.github.io/organization-geospatial/03-crs" class="external-link">an
earlier lesson</a>.</p>
<p>Now we will see how features of the CRS appear in our data file and
what meanings they have.</p>
<div class="section level3">
<h3 id="view-raster-coordinate-reference-system-crs-in-r">View Raster Coordinate Reference System (CRS) in R<a class="anchor" aria-label="anchor" href="#view-raster-coordinate-reference-system-crs-in-r"></a>
</h3>
<p>We can view the CRS string associated with our R object using
the<code>crs()</code> function.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">b10_casco_2023</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=utm +zone=19 +datum=WGS84 +units=m +no_defs"</code></pre>
</div>
<div id="challenge" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge" class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge"></a>
</h3>
<div class="callout-content">
<p>What units are our data in?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Answers</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p><code>+units=m</code> tells us that our data is in meters.</p>
</div>
</div>
</div>
</div>
</div>
</section><section id="understanding-crs-in-proj4-format"><h2 class="section-heading">Understanding CRS in Proj4 Format<a class="anchor" aria-label="anchor" href="#understanding-crs-in-proj4-format"></a>
</h2>
<hr class="half-width">
<p>The CRS for our data is given to us by R in <code>proj4</code>
format. Let’s break down the pieces of <code>proj4</code> string. The
string contains all of the individual CRS elements that R or another GIS
might need. Each element is specified with a <code>+</code> sign,
similar to how a <code>.csv</code> file is delimited or broken up by a
<code>,</code>. After each <code>+</code> we see the CRS element being
defined. For example projection (<code>proj=</code>) and datum
(<code>datum=</code>).</p>
<div class="section level3">
<h3 id="utm-proj4-string">UTM Proj4 String<a class="anchor" aria-label="anchor" href="#utm-proj4-string"></a>
</h3>
<p>A projection string (like the one of <code>b10_casco_2023</code>)
specifies the UTM projection as follows:</p>
<p><code>+proj=utm +zone=19 +datum=WGS84 +units=m +no_defs</code></p>
<ul>
<li>
<strong>proj=utm:</strong> the projection is UTM, UTM has several
zones.</li>
<li>
<strong>zone=19:</strong> the zone is 19</li>
<li>
<strong>datum=WGS84:</strong> the datum is WGS84 (the datum refers
to the 0,0 reference for the coordinate system used in the
projection)</li>
<li>
<strong>units=m:</strong> the units for the coordinates are in
meters</li>
</ul>
<p>Note that the zone is unique to the UTM projection. Not all CRSs will
have a zone. Image source: Chrismurf at English Wikipedia, via <a href="https://en.wikipedia.org/wiki/Universal_Transverse_Mercator_coordinate_system#/media/File:Utm-zones-USA.svg" class="external-link">Wikimedia
Commons</a> (CC-BY).</p>
<figure><img src="fig/Utm-zones-USA.svg" alt="UTM zones in the USA." class="figure mx-auto d-block"><figcaption>The UTM zones across the continental United States.
From: <a href="https://upload.wikimedia.org/wikipedia/commons/8/8d/Utm-zones-USA.svg" class="external-link uri">https://upload.wikimedia.org/wikipedia/commons/8/8d/Utm-zones-USA.svg</a></figcaption></figure>
</div>
</section><section id="calculate-raster-min-and-max-values"><h2 class="section-heading">Calculate Raster Min and Max Values<a class="anchor" aria-label="anchor" href="#calculate-raster-min-and-max-values"></a>
</h2>
<hr class="half-width">
<p>It is useful to know the minimum or maximum values of a raster
dataset. In this case, given we are working with elevation data, these
values represent the min/max elevation range at our site.</p>
<p>Raster statistics are often calculated and embedded in a GeoTIFF for
us. We can view these values:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">minmax</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    SST_F_20230920
min       47.09686
max       80.46152</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">min</span><span class="op">(</span><span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 47.09686</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">max</span><span class="op">(</span><span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 80.46152</code></pre>
</div>
<div id="data-tip---set-min-and-max-values" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip---set-min-and-max-values" class="callout-inner">
<h3 class="callout-title">Data Tip - Set min and max values<a class="anchor" aria-label="anchor" href="#data-tip---set-min-and-max-values"></a>
</h3>
<div class="callout-content">
<p>If the minimum and maximum values haven’t already been calculated, we
can calculate them using the <code>setMinMax()</code> function.</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2023</span> <span class="op">&lt;-</span> <span class="fu">setMinMax</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>We can see that the elevation at our site ranges from NaNm to
NaNm.</p>
</section><section id="raster-bands"><h2 class="section-heading">Raster Bands<a class="anchor" aria-label="anchor" href="#raster-bands"></a>
</h2>
<hr class="half-width">
<p>The Digital Surface Model object (<code>b10_casco_2023</code>) that
we’ve been working with is a single band raster. This means that there
is only one dataset stored in the raster: surface elevation in meters
for one time period.</p>
<figure><img src="fig/dc-spatial-raster/single_multi_raster.png" alt="Multi-band raster image" class="figure mx-auto d-block"></figure><p>A raster dataset can contain one or more bands. We can use the
<code>rast()</code> function to import one single band from a single or
multi-band raster. We can view the number of bands in a raster using the
<code>nly()</code> function.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">nlyr</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1</code></pre>
</div>
<p>However, raster data can also be multi-band, meaning that one raster
file contains data for more than one variable or time period for each
cell. By default the <code>raster()</code> function only imports the
first band in a raster regardless of whether it has one or more bands.
Jump to a later episode in this series for information on working with
multi-band rasters: <a href="05-raster-multi-band-in-r/">Work with
Multi-band Rasters in R</a>.</p>
</section><section id="bad-data-values-in-rasters"><h2 class="section-heading">Bad Data Values in Rasters<a class="anchor" aria-label="anchor" href="#bad-data-values-in-rasters"></a>
</h2>
<hr class="half-width">
<p>Sometimes your rasters can have bad data values. These are different
from <code>NoData Value</code>s, which get represented by NAs. Bad data
values are values that fall outside of the applicable range of a
dataset.</p>
<p>Examples of Bad Data Values:</p>
<ul>
<li>The normalized difference vegetation index (NDVI), which is a
measure of greenness, has a valid range of -1 to 1. Any value outside of
that range would be considered a “bad” or miscalculated value.</li>
<li>Reflectance data in an image will often range from 0-1 or 0-10,000
depending upon how the data are scaled. Thus a value greater than 1 or
greater than 10,000 is likely caused by an error in either data
collection or processing.<br>
</li>
<li>Coastal ocean data could be contaminated by measurements from
land.</li>
</ul>
<div class="section level3">
<h3 id="find-bad-data-values">Find Bad Data Values<a class="anchor" aria-label="anchor" href="#find-bad-data-values"></a>
</h3>
<p>Sometimes a raster’s metadata will tell us the range of expected
values for a raster. Values outside of this range are suspect and we
need to consider that when we analyze the data. Sometimes, we need to
use some common sense and scientific insight as we examine the data -
just as we would for field data to identify questionable values.</p>
<p>Plotting data with appropriate highlighting can help reveal patterns
in bad values and may suggest a solution. For example, let’s look at the
range of our SST raster.</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">minmax</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    SST_F_20230920
min       47.09686
max       80.46152</code></pre>
</div>
<p>47F seems reasonable, but 80? Maybe it is. But maybe it’s just land
values that bled over. Let’s assume 75F is the real maximum. To view
where we might have bad data, we can use <code>classify()</code> which
takes a matrix with three columns. The first is a low value. The second
is a high value. And the third is how we want that classified. Let’s say
we wanted to look at bad values in our SST dataset.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reclassify raster to ok/not ok</span></span>
<span><span class="va">range_matrix</span> <span class="op">&lt;-</span> <span class="fu">matrix</span><span class="op">(</span><span class="fu">c</span><span class="op">(</span></span>
<span>  <span class="fl">40</span>,<span class="fl">75</span>, <span class="fl">1</span>, <span class="co">#low, high, make a 1</span></span>
<span>  <span class="fl">75</span>, <span class="fl">90</span>, <span class="fl">2</span></span>
<span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b10_highvals</span> <span class="op">&lt;-</span> <span class="fu">classify</span><span class="op">(</span><span class="va">b10_casco_2023</span>,</span>
<span>                         rcl <span class="op">=</span> <span class="va">range_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot</span><span class="op">(</span><span class="va">b10_highvals</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/01-raster-structure-rendered-demo-bad-data-highlighting-1.png" alt="Raster plot showing location of extreme values" class="figure mx-auto d-block"><figcaption>
Raster plot showing location of extreme values
</figcaption></figure><p>Yeah, it’s some spots at the tail-end of the coast that could indeed
by pixels contaminated by land. To fix that, we can set values outside
of our range to NA using <code>clamp()</code></p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2023</span> <span class="op">&lt;-</span> <span class="fu">clamp</span><span class="op">(</span><span class="va">b10_casco_2023</span>, </span>
<span>                        lower <span class="op">=</span> <span class="fl">40</span>,</span>
<span>                        upper <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">minmax</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    SST_F_20230920
min       47.09686
max       75.00000</code></pre>
</div>
</div>
</section><section id="create-a-histogram-of-raster-values"><h2 class="section-heading">Create A Histogram of Raster Values<a class="anchor" aria-label="anchor" href="#create-a-histogram-of-raster-values"></a>
</h2>
<hr class="half-width">
<p>We can explore the distribution of values contained within our raster
using the <code>geom_histogram()</code> function which produces a
histogram. Histograms are often useful in identifying outliers and bad
data values in our raster data.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023_df</span>, </span>
<span>                   mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">SST_F_20230920</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/01-raster-structure-rendered-view-raster-histogram-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Notice that a warning message is thrown when R creates the
histogram.</p>
<p><code>stat_bin()</code> using <code>bins = 30</code>. Pick better
value with <code>binwidth</code>.</p>
<p>This warning is caused by a default setting in
<code>geom_histogram</code> enforcing that there are 30 bins for the
data. We can define the number of bins we want in the histogram by using
the <code>bins</code> value in the <code>geom_histogram()</code>
function.</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023_df</span>, </span>
<span>                   mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">SST_F_20230920</span><span class="op">)</span>,</span>
<span>                   bins <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/01-raster-structure-rendered-view-raster-histogram2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Note that the shape of this histogram looks similar to the previous
one that was created using the default of 30 bins. The distribution of
SST values looks reasonable. Although, we can see some very thin tails
that we might want to inspect to see if they are real values or bad
data.</p>
<div id="challenge-explore-raster-metadata" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-explore-raster-metadata" class="callout-inner">
<h3 class="callout-title">Challenge: Explore Raster Metadata<a class="anchor" aria-label="anchor" href="#challenge-explore-raster-metadata"></a>
</h3>
<div class="callout-content">
<p>Use <code>describe()</code> to determine the following about the
<code>data/landsat_casco/b10_cropped/LC08_L2SP_011030_20130815_20200912_02_T1_ST_B10.TIF</code>
file:</p>
<ol style="list-style-type: decimal">
<li>Does this file have the same CRS as
<code>b10_casco_2023_df</code>?</li>
<li>What is the <code>NoData Value</code>?</li>
<li>What is resolution of the raster data?</li>
<li>How large would a 5x5 pixel area be on the Earth’s surface?</li>
<li>Is the file a multi- or single-band raster?</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Answers</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/landsat_casco/b10_cropped/LC08_L2SP_011030_20130815_20200912_02_T1_ST_B10.TIF"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"                                                                                                                                                                                                                                                                                                                          
 [2] "Files: data/landsat_casco/b10_cropped/LC08_L2SP_011030_20130815_20200912_02_T1_ST_B10.TIF"                                                                                                                                                                                                                                                      
 [3] "Size is 1128, 1349"                                                                                                                                                                                                                                                                                                                             
 [4] "Coordinate System is:"                                                                                                                                                                                                                                                                                                                          
 [5] "PROJCRS[\"WGS 84 / UTM zone 19N\","                                                                                                                                                                                                                                                                                                             
 [6] "    BASEGEOGCRS[\"WGS 84\","                                                                                                                                                                                                                                                                                                                    
 [7] "        DATUM[\"World Geodetic System 1984\","                                                                                                                                                                                                                                                                                                  
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"                                                                                                                                                                                                                                                                                        
 [9] "                LENGTHUNIT[\"metre\",1]]],"                                                                                                                                                                                                                                                                                                     
[10] "        PRIMEM[\"Greenwich\",0,"                                                                                                                                                                                                                                                                                                                
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"                                                                                                                                                                                                                                                                                         
[12] "        ID[\"EPSG\",4326]],"                                                                                                                                                                                                                                                                                                                    
[13] "    CONVERSION[\"UTM zone 19N\","                                                                                                                                                                                                                                                                                                               
[14] "        METHOD[\"Transverse Mercator\","                                                                                                                                                                                                                                                                                                        
[15] "            ID[\"EPSG\",9807]],"                                                                                                                                                                                                                                                                                                                
[16] "        PARAMETER[\"Latitude of natural origin\",0,"                                                                                                                                                                                                                                                                                            
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"                                                                                                                                                                                                                                                                                          
[18] "            ID[\"EPSG\",8801]],"                                                                                                                                                                                                                                                                                                                
[19] "        PARAMETER[\"Longitude of natural origin\",-69,"                                                                                                                                                                                                                                                                                         
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"                                                                                                                                                                                                                                                                                          
[21] "            ID[\"EPSG\",8802]],"                                                                                                                                                                                                                                                                                                                
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"                                                                                                                                                                                                                                                                                   
[23] "            SCALEUNIT[\"unity\",1],"                                                                                                                                                                                                                                                                                                            
[24] "            ID[\"EPSG\",8805]],"                                                                                                                                                                                                                                                                                                                
[25] "        PARAMETER[\"False easting\",500000,"                                                                                                                                                                                                                                                                                                    
[26] "            LENGTHUNIT[\"metre\",1],"                                                                                                                                                                                                                                                                                                           
[27] "            ID[\"EPSG\",8806]],"                                                                                                                                                                                                                                                                                                                
[28] "        PARAMETER[\"False northing\",0,"                                                                                                                                                                                                                                                                                                        
[29] "            LENGTHUNIT[\"metre\",1],"                                                                                                                                                                                                                                                                                                           
[30] "            ID[\"EPSG\",8807]]],"                                                                                                                                                                                                                                                                                                               
[31] "    CS[Cartesian,2],"                                                                                                                                                                                                                                                                                                                           
[32] "        AXIS[\"(E)\",east,"                                                                                                                                                                                                                                                                                                                     
[33] "            ORDER[1],"                                                                                                                                                                                                                                                                                                                          
[34] "            LENGTHUNIT[\"metre\",1]],"                                                                                                                                                                                                                                                                                                          
[35] "        AXIS[\"(N)\",north,"                                                                                                                                                                                                                                                                                                                    
[36] "            ORDER[2],"                                                                                                                                                                                                                                                                                                                          
[37] "            LENGTHUNIT[\"metre\",1]],"                                                                                                                                                                                                                                                                                                          
[38] "    USAGE["                                                                                                                                                                                                                                                                                                                                     
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"                                                                                                                                                                                                                                                                                   
[40] "        AREA[\"Between 72°W and 66°W, northern hemisphere between equator and 84°N, onshore and offshore. Aruba. Bahamas. Brazil. Canada - New Brunswick (NB); Labrador; Nunavut; Nova Scotia (NS); Quebec. Colombia. Dominican Republic. Greenland. Netherlands Antilles. Puerto Rico. Turks and Caicos Islands. United States. Venezuela.\"],"
[41] "        BBOX[0,-72,84,-66]],"                                                                                                                                                                                                                                                                                                                   
[42] "    ID[\"EPSG\",32619]]"                                                                                                                                                                                                                                                                                                                        
[43] "Data axis to CRS axis mapping: 1,2"                                                                                                                                                                                                                                                                                                             
[44] "Origin = (398865.000000000000000,4866405.000000000000000)"                                                                                                                                                                                                                                                                                      
[45] "Pixel Size = (30.000000000000000,-30.000000000000000)"                                                                                                                                                                                                                                                                                          
[46] "Metadata:"                                                                                                                                                                                                                                                                                                                                      
[47] "  AREA_OR_POINT=Area"                                                                                                                                                                                                                                                                                                                           
[48] "Image Structure Metadata:"                                                                                                                                                                                                                                                                                                                      
[49] "  COMPRESSION=LZW"                                                                                                                                                                                                                                                                                                                              
[50] "  INTERLEAVE=BAND"                                                                                                                                                                                                                                                                                                                              
[51] "Corner Coordinates:"                                                                                                                                                                                                                                                                                                                            
[52] "Upper Left  (  398865.000, 4866405.000) ( 70d15'36.90\"W, 43d56'37.75\"N)"                                                                                                                                                                                                                                                                      
[53] "Lower Left  (  398865.000, 4825935.000) ( 70d15' 9.45\"W, 43d34'46.27\"N)"                                                                                                                                                                                                                                                                      
[54] "Upper Right (  432705.000, 4866405.000) ( 69d50'19.04\"W, 43d56'51.69\"N)"                                                                                                                                                                                                                                                                      
[55] "Lower Right (  432705.000, 4825935.000) ( 69d50' 0.77\"W, 43d35' 0.04\"N)"                                                                                                                                                                                                                                                                      
[56] "Center      (  415785.000, 4846170.000) ( 70d 2'46.52\"W, 43d45'49.65\"N)"                                                                                                                                                                                                                                                                      
[57] "Band 1 Block=1128x1 Type=Float32, ColorInterp=Gray"                                                                                                                                                                                                                                                                                             
[58] "  Description = SST_F_20130815"                                                                                                                                                                                                                                                                                                                 
[59] "  Min=51.010 Max=89.659 "                                                                                                                                                                                                                                                                                                                       
[60] "  Minimum=51.010, Maximum=89.659, Mean=-9999.000, StdDev=-9999.000"                                                                                                                                                                                                                                                                             
[61] "  NoData Value=nan"                                                                                                                                                                                                                                                                                                                             
[62] "  Metadata:"                                                                                                                                                                                                                                                                                                                                    
[63] "    STATISTICS_MAXIMUM=89.659408569336"                                                                                                                                                                                                                                                                                                         
[64] "    STATISTICS_MEAN=-9999"                                                                                                                                                                                                                                                                                                                      
[65] "    STATISTICS_MINIMUM=51.00980758667"                                                                                                                                                                                                                                                                                                          
[66] "    STATISTICS_STDDEV=-9999"                                                                                                                                                                                                                                                                                                                    </code></pre>
</div>
<ol style="list-style-type: decimal">
<li>If this file has the same CRS as DSM_HARV? Yes: UTM Zone 19, WGS84,
meters.</li>
<li>What format <code>NoData Values</code> take? 0</li>
<li>The resolution of the raster data? 1x1</li>
<li>How large a 5x5 pixel area would be? 5mx5m How? We are given
resolution of 1x1 and units in meters, therefore resolution of 5x5 means
5x5m.</li>
<li>Is the file a multi- or single-band raster? Single.</li>
</ol>
</div>
</div>
</div>
</div>
<div id="more-resources" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="more-resources" class="callout-inner">
<h3 class="callout-title">More Resources<a class="anchor" aria-label="anchor" href="#more-resources"></a>
</h3>
<div class="callout-content">
<ul>
<li><a href="https://cran.r-project.org/package=terra" class="external-link">Read more about
the <code>terra</code> package in R.</a></li>
</ul>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>The GeoTIFF file format includes metadata about the raster
data.</li>
<li>To plot raster data with the <code>ggplot2</code> package, we need
to convert it to a dataframe.</li>
<li>R stores CRS information in the Proj4 format.</li>
<li>Be careful when dealing with missing or bad data values.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-02-raster-plot"><p>Content from <a href="02-raster-plot.html">Plot Raster Data</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/02-raster-plot.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I create categorized or customized maps of raster data?</li>
<li>How can I customize the color scheme of a raster image?</li>
<li>How can I make my visualizations interactive?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Build customized plots for a single band raster using the
<code>ggplot2</code> package.</li>
<li>Make interactive maps with leaflet</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>First, let’s load some libraries. You should have them loaded from
the previous less, but in case you don’t -</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyterra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span></code></pre>
</div>
<p>We are also going to load one new library.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span></code></pre>
</div>
<p>To remind you, this is the data we will be using -</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Learners will have this data loaded from earlier episode</span></span>
<span><span class="co"># DSM data for Harvard Forest</span></span>
<span><span class="va">b10_casco_2023</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/landsat_casco/b10_cropped/LC09_L2SP_011030_20230920_20230922_02_T1_ST_B10.TIF"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">clamp</span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">50</span>,</span>
<span>        upper <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b10_casco_2023_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">b10_casco_2023</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<section id="plot-raster-data-in-r"><h2 class="section-heading">Plot Raster Data in R<a class="anchor" aria-label="anchor" href="#plot-raster-data-in-r"></a>
</h2>
<hr class="half-width">
<p>This episode covers how to plot a raster in R using the
<code>ggplot2</code> package with customized coloring schemes. We will
then make interactive maps with <code>leaflet</code>.</p>
<p>We will continue working with the Landsat SST data from Casco
Bay.</p>
</section><section id="plotting-data-using-breaks"><h2 class="section-heading">Plotting Data Using Breaks<a class="anchor" aria-label="anchor" href="#plotting-data-using-breaks"></a>
</h2>
<hr class="half-width">
<p>In the previous episode, we viewed our data using a continuous color
ramp. For clarity and visibility of the plot - or if there are classes
you are interested in - we may prefer to view the data “symbolized” or
colored according to ranges of values. This is comparable to a
“classified” map. To do this, we need to tell <code>ggplot</code> how
many groups to break our data into, and where those breaks should be. To
make these decisions, it is useful to first explore the distribution of
the data using a bar plot. To begin with, we will use
<code>dplyr</code>’s <code>mutate()</code> function combined with
<code>cut()</code> to split the data into 4 bins.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2023_df</span> <span class="op">&lt;-</span> <span class="va">b10_casco_2023_df</span> <span class="op">%&gt;%</span></span>
<span>                <span class="fu">mutate</span><span class="op">(</span>fct_sst <span class="op">=</span> <span class="fu">cut</span><span class="op">(</span><span class="va">SST_F_20230920</span>, breaks <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_bar</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">fct_sst</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-histogram-breaks-ggplot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>If we want to know the cutoff values for the groups, we can ask for
the unique values of <code>fct_sst</code>:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unique</span><span class="op">(</span><span class="va">b10_casco_2023_df</span><span class="op">$</span><span class="va">fct_sst</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] (62.5,68.8] (68.8,75]   (56.2,62.5] (50,56.2]  
Levels: (50,56.2] (56.2,62.5] (62.5,68.8] (68.8,75]</code></pre>
</div>
<p>And we can get the count of values in each group using
<code>dplyr</code>’s <code>group_by()</code> and <code>count()</code>
functions:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2023_df</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">group_by</span><span class="op">(</span><span class="va">fct_sst</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">count</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 4 × 2
# Groups:   fct_sst [4]
  fct_sst          n
  &lt;fct&gt;        &lt;int&gt;
1 (50,56.2]     2370
2 (56.2,62.5] 657710
3 (62.5,68.8]  92571
4 (68.8,75]     2461</code></pre>
</div>
<p>We might prefer to customize the cutoff values for these groups. Lets
round the cutoff values so that we have groups for the ranges of 50 –
55F, 55 – 60F, 65 - 70F and 70-75F. To implement this we will give
<code>mutate()</code> a numeric vector of break points instead of the
number of breaks we want.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_bins</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">50</span>, <span class="fl">55</span>, <span class="fl">60</span>, <span class="fl">65</span>, <span class="fl">70</span>, <span class="fl">75</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b10_casco_2023_df</span> <span class="op">&lt;-</span> <span class="va">b10_casco_2023_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fct_sst_2 <span class="op">=</span> <span class="fu">cut</span><span class="op">(</span><span class="va">SST_F_20230920</span>, breaks <span class="op">=</span> <span class="va">custom_bins</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">unique</span><span class="op">(</span><span class="va">b10_casco_2023_df</span><span class="op">$</span><span class="va">fct_sst_2</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] (65,70] (70,75] (60,65] (55,60] (50,55] &lt;NA&gt;   
Levels: (50,55] (55,60] (60,65] (65,70] (70,75]</code></pre>
</div>
<p><code>cut()</code> is a powerful function, and there are a series of
related ones that are quite useful.</p>
<table class="table">
<colgroup>
<col width="53%">
<col width="46%">
</colgroup>
<thead><tr class="header">
<th>function</th>
<th>what it does</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>cut</td>
<td>makes groups based on pre-defined breakpoints</td>
</tr>
<tr class="even">
<td>cut_interval</td>
<td>makes n groups with equal range</td>
</tr>
<tr class="odd">
<td>cut_width</td>
<td>makes groups with a given width</td>
</tr>
<tr class="even">
<td>cut_number</td>
<td>makes n groups with an equal number of observations</td>
</tr>
</tbody>
</table>
<p>Try them out with <code>b10_casco_2023_df$SST_F_20230920</code> to
see how they differ.</p>
<div id="data-tips" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tips" class="callout-inner">
<h3 class="callout-title">Data Tips<a class="anchor" aria-label="anchor" href="#data-tips"></a>
</h3>
<div class="callout-content">
<p>Note that when we assign break values a set of 6 values will result
in 5 bins of data.</p>
<p>The bin intervals are shown using <code>(</code> to mean exclusive
and <code>]</code> to mean inclusive. For example: <code>(65, 70]</code>
means “from 65 through 70”.</p>
</div>
</div>
</div>
<p>And now we can plot our bar plot again, using the new groups:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023_df</span>, </span>
<span>           mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span><span class="va">fct_sst_2</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-histogram-custom-breaks-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>And we can get the count of values in each group in the same way we
did before:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2023_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">fct_sst_2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 6 × 2
# Groups:   fct_sst_2 [6]
  fct_sst_2      n
  &lt;fct&gt;      &lt;int&gt;
1 (50,55]     1483
2 (55,60]   176310
3 (60,65]   562050
4 (65,70]    13284
5 (70,75]     1715
6 &lt;NA&gt;         270</code></pre>
</div>
<p>We can use those groups to plot our raster data, with each group
being a different color. We could do this with our data frame, or, we
can use the <code>scale_color_binned()</code> color scale. This is a
feature of <code>ggplot2</code> that lets you create bins on the fly and
plot them. We can specify our custom breaks with the <code>breaks</code>
argument.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_binned</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">custom_bins</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-raster-with-breaks-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>A lot of color scales have binned versions. We could have done the
above with <code>scale_fill_viridis_b()</code>. Or we could place with
<code>scale_fill_fermenter()</code> which comes from <a href="https://colorbrewer2.org/" class="external-link">Color Brewer</a>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_fermenter</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">custom_bins</span>,</span>
<span>                       palette <span class="op">=</span> <span class="st">"Accent"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-raster-with-breaks-fermenter-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Note the choices of palette. ColorBrewer supplies quite a few to
try!</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu">display.brewer.all</span><span class="op">(</span><span class="op">)</span> </span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-show-brewer-pal-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>This is just the tip of the iceberg when looking for color palettes
for R, and it’s a topic well worth searching out when you want to
customize your own plots to the nth degree. You can even make your own
custom palette with <code>scale_fill_stepsn()</code>.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_pal</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"purple"</span>, <span class="st">"orange"</span>, <span class="st">"yellow"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">custom_bins</span>,,</span>
<span>                    colors <span class="op">=</span> <span class="va">my_pal</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-binned_scale_manual-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>One advantage to this is that you can then use the same breaks and
color palette across multiple plots for consistency, rather than having
<code>ggplot2</code> choose the breaks and palette stretching for you.
There are also many wonderful palette packages, like <a href="https://github.com/karthik/wesanderson" class="external-link">wesanderson</a> or <a href="https://github.com/dill/beyonce" class="external-link">beyonce</a>.</p>
<div class="section level3">
<h3 id="more-plot-formatting">More Plot Formatting<a class="anchor" aria-label="anchor" href="#more-plot-formatting"></a>
</h3>
<p>All labels in a plot can be controlled by the <code>labs()</code>
function. So, if we wanted to give the fill name “SST (F)”, label the X
and Y axis, and give this plot a title of “SST on Sept 9, 2023” we can
do so easily.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">custom_bins</span>,,</span>
<span>                    colors <span class="op">=</span> <span class="va">my_pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"SST on Sept 9, 2023"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"SST (F)"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-add-ggplot-labels-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We can also retheme the entire plot - changing the background, axis
options, and more. If you really want to get deeply into themes, there
are many wonderful packages out there like <a href="https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/" class="external-link">ggthemes</a>,
<a href="https://ryo-n7.github.io/tvthemes/" class="external-link">tvthemes</a>, <a href="https://cinc.rud.is/web/packages/hrbrthemes/" class="external-link">hrbrthemes</a>, <a href="https://nanx.me/ggsci/" class="external-link">ggsci</a>, and so many more.</p>
<p>Within ggplot itself, chekc out the different <code>theme_*()</code>
functions, such as <code>theme_void()</code>. We can use the
<code>base_size</code> argument to specify a base font size as well.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2023</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">custom_bins</span>,,</span>
<span>                    colors <span class="op">=</span> <span class="va">my_pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"SST on Sept 9, 2023"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"SST (F)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-turn-off-axes-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>You can also make your own custom theme or theme modifications with
the <code>theme()</code> function. Dig into the <code>?theme</code>
helpfile to learn more and see examples.</p>
<div id="challenge-plot-using-custom-breaks" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-using-custom-breaks" class="callout-inner">
<h3 class="callout-title">Challenge: Plot Using Custom Breaks<a class="anchor" aria-label="anchor" href="#challenge-plot-using-custom-breaks"></a>
</h3>
<div class="callout-content">
<p>Create a plot of the Casco Bay SST in August 2013 that has:</p>
<ol style="list-style-type: decimal">
<li>Three classified ranges of values (break points) that are evenly
divided among the range of pixel values. Any palette you’d like!</li>
<li>Axis labels.</li>
<li>A plot title.</li>
<li>A unique theme.</li>
</ol>
<p>The file is
<code>data/landsat_casco/b10_cropped/LC08_L2SP_011030_20130815_20200912_02_T1_ST_B10.TIF</code>
to remind you.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Answers</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2013</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="st">"data/landsat_casco/b10_cropped/LC08_L2SP_011030_20130815_20200912_02_T1_ST_B10.TIF"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># find intervals</span></span>
<span><span class="fu">cut_interval</span><span class="op">(</span><span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2013</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">levels</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># round those intervals into breaks</span></span>
<span><span class="va">new_breaks</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">50</span>, <span class="fl">65</span>, <span class="fl">75</span>, <span class="fl">85</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot with these new breaks using Set2 as the palette</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2013</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_fermenter</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">new_breaks</span>,</span>
<span>                    palette <span class="op">=</span> <span class="st">"Set2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"SST on Aug 15, 2023"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"SST (F)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggthemes</span><span class="fu">::</span><span class="fu">theme_few</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section id="interactive-maps"><h2 class="section-heading">Interactive Maps<a class="anchor" aria-label="anchor" href="#interactive-maps"></a>
</h2>
<hr class="half-width">
<p>These static maps are beautiful, but, they can be difficult if you
notice features occurring at small scales you want to investigate.
They’re also wonderful objects to build for web applications and the
like, as they allow users a degree of interactivity.</p>
<p>For a basic level of interactivity - just to explore -
<code>terra</code> includes a function called <code>plet()</code> which
lets us look at our raster interactively.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plet</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-plet-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>This is great, and we can even put some reference behind it with the
<code>tiles</code> argument.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plet</span><span class="op">(</span><span class="va">b10_casco_2023</span>, tile <span class="op">=</span> <span class="st">"Esri.WorldImagery"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-plet-tiles-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>What do you learn from this?</p>
<div id="challenge" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge" class="callout-inner">
<h3 class="callout-title">Challenge:<a class="anchor" aria-label="anchor" href="#challenge"></a>
</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>What does 2013 look like by comparison? Are spatial patterns the
same, or different?</p></li>
<li><p>There are many <code>tiles</code> options. Try “Streets” and
“OpenTopoMap”. Which do you prefer and why?</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Answers</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plet</span><span class="op">(</span><span class="va">b10_casco_2023</span>, tile <span class="op">=</span> <span class="st">"Street"</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="data-tips-1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tips-1" class="callout-inner">
<h3 class="callout-title">Data Tips<a class="anchor" aria-label="anchor" href="#data-tips-1"></a>
</h3>
<div class="callout-content">
<p>If you want to make sure things can be seen behind the raster, try
fiddling with the <code>alpha</code> values. It’s set to 0.8 by default
The alpha value determines how transparent the colors will be (0 being
transparent, 1 being opaque).</p>
<p>There are other options for <code>plet</code> that could be well
worth an exploration as you use it to try and understand what is
happening in your raster imagery.</p>
</div>
</div>
</div>
<p>The above is well and good for exploration, but for presentation you
might something more customized. Did you notice in the lowe right-hand
corner the word “leaflet”? This is the name of a Javascript library that
powers a lot of interactive maps you see on the internet.
<code>plet()</code> actually calls an R library <code>leaflet</code>
that then interacts with the Javascript library to make these maps. You
can learn a lot more about <code>leaflet</code> for R from <a href="https://rstudio.github.io/leaflet/" class="external-link">here</a>.</p>
<p>The <code>leaflet</code> library works in some very similar and some
very different ways from <code>ggplot2</code>. It’s useful to know as it
allows us to customize the presentation of our maps for a public
audience. It works by building a map up in a sequence of layers, like
<code>ggplot2</code>, except that it uses the pipe to add each new
element. For example, to generate the above map, we’d have to first
initialize a <code>leaflet()</code> map, then <code>addTiles()</code>,
and finally <code>addRasterImage()</code>.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-leaflet-basic-plot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Note that the color palette is different as is the background map
from <code>plet()</code>. This is all customizable!</p>
<p><code>addTiles()</code> takes an argument <code>urlTemplate</code>
which looks a bit odd, but, you can get the arguments for different
tilesets from <a href="https://leaflet-extras.github.io/leaflet-providers/preview/index.html" class="external-link">this
site</a>. Or use <code>addProviderTiles()</code> to just specify a
provider and map.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Esri.WorldImagery"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span><span class="va">b10_casco_2023</span>, opacity <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-show-leaflet-tiles-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>For colors, we can specify a color mapping - from our raster to a
palette. There are four functions for this. <code>colorNumeric()</code>
is for continuous values. <code>colorBin()</code> does what we’ve been
doing with <code>scale_fill_binned()</code>. We can use discrete values
with <code>colorFactor()</code> or if we want to use quantiles (e.g., to
highlight 95th percentiles and extremes beyond them), we can use
<code>colorQuantile()</code>. Each takes a palette, which we can either
specify as a vector of colors or a name of a ColorBrewer or Viridis
palette. It also takes a domain, the values the palette will be mapped
to.</p>
<p>What’s great about defining a palette here is that we can then use it
for <code>addLegend()</code> or for other maps to have equivalent
scales. Here’s an example using the <code>RdYlBu</code> palette. Don’t
forget to set <code>na.color = "transparent"</code> if you don’t want to
see it.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># note, using reverse = TRUE here as otherwise warm = blue</span></span>
<span><span class="va">my_pal</span> <span class="op">&lt;-</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdYlBu"</span>,</span>
<span>                    domain <span class="op">=</span> <span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span>,</span>
<span>                    na.color <span class="op">=</span> <span class="st">"transparent"</span>,</span>
<span>                    reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span><span class="va">b10_casco_2023</span>,</span>
<span>                 colors <span class="op">=</span> <span class="va">my_pal</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addLegend</span><span class="op">(</span>pal <span class="op">=</span> <span class="va">my_pal</span>, </span>
<span>            values <span class="op">=</span> <span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2023</span><span class="op">)</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"SST (F)"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-show-leaflet-colors-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-1" class="callout-inner">
<h3 class="callout-title">Challenge:<a class="anchor" aria-label="anchor" href="#challenge-1"></a>
</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>Put together a leaflet map of 2013.</li>
<li>Add a tileset that you like.</li>
<li>Add colors to make it pop!</li>
<li>Look at the arguments for <code>addLegend()</code> to move it where
you want. If you’d like to go big, check out <code>addMiniMap()</code>,
<code>addScaleBar()</code>, or <code>addLayersControl()</code> with
multiple tile sets</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Answers</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's do bins!</span></span>
<span><span class="va">new_pal</span> <span class="op">&lt;-</span> <span class="fu">colorBin</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"plasma"</span>,</span>
<span>                    domain <span class="op">=</span> <span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2013</span><span class="op">)</span>,</span>
<span>                    na.color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Esri.WorldTerrain"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Thunderforest.SpinalMap"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Esri.WorldImagery"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span><span class="va">b10_casco_2013</span>,</span>
<span>                 colors <span class="op">=</span> <span class="va">new_pal</span>,</span>
<span>                 opacity <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addLegend</span><span class="op">(</span>pal <span class="op">=</span> <span class="va">new_pal</span>, </span>
<span>            values <span class="op">=</span> <span class="fu">values</span><span class="op">(</span><span class="va">b10_casco_2013</span><span class="op">)</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"SST (F)"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addScaleBar</span><span class="op">(</span><span class="st">"bottomleft"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addLayersControl</span><span class="op">(</span>position <span class="op">=</span> <span class="st">"bottomright"</span>,</span>
<span>                   baseGroups <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"World Terrain"</span>, </span>
<span>                                  <span class="st">"This Is Spinal Map!"</span>,</span>
<span>                                  <span class="st">"World Imagery"</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Continuous data ranges can be grouped into categories using
<code>mutate()</code> and <code>cut()</code> or with a binned color
scale in <code>ggplot2</code>.</li>
<li>Use built-in color palettes with <code>scale_fill_viridis_b</code>
or <code>scale_fill_fermenter()</code> or set your preferred color
scheme manually.</li>
<li>Interactive plotting with <code>plet()</code> and the
<code>leaflet</code> library can lead to even better insights as you
zoom in and out.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-06-vector-open-shapefile-in-r"><p>Content from <a href="06-vector-open-shapefile-in-r.html">Open and Plot Vector Layers</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/06-vector-open-shapefile-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I distinguish between and visualize point, line and polygon
vector data?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Know the difference between point, line, and polygon vector
elements.</li>
<li>Load point, line, and polygon vector layers into R.</li>
<li>Access the attributes of a spatial object in R.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>First, some libraries you might not have loaded at the moment.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span></code></pre>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>Starting with this episode, we will be moving from working with
raster data to working with vector data. In this episode, we will open
and plot point, line and polygon vector data loaded from ESRI’s
<code>shapefile</code> format into R. These data refer to data from the
<a href="https://www.maine.gov/geolib/catalog.html" class="external-link">Maine GeoLibrary
Data Catalogue</a> on seagrass beds, public roads, and boat launches. In
later episodes, we will learn how to work with raster and vector data
together and combine them into a single plot.</p>
<section id="import-vector-data"><h2 class="section-heading">Import Vector Data<a class="anchor" aria-label="anchor" href="#import-vector-data"></a>
</h2>
<hr class="half-width">
<p>We will use the <code>sf</code> package to work with vector data in
R. We will also use the <code>terra</code> package, which has been
loaded in previous episodes, so we can explore raster and vector spatial
metadata using similar commands. Make sure you have the <code>sf</code>
library loaded.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span></code></pre>
</div>
<p>The vector layers that we will import from ESRI’s
<code>shapefile</code> format are:</p>
<ul>
<li>A polygon vector layer representing our field site boundary,</li>
<li>A line vector layer representing the public roads of Maine, and</li>
<li>A point vector layer representing the location of the boat launches
around Maine.</li>
</ul>
<p>The first vector layer that we will open contains the boundary of our
study area (or our Area Of Interest or AOI, hence the name
<code>aoiBoundary</code>). To import a vector layer from an ESRI
<code>shapefile</code> we use the <code>sf</code> function
<code>st_read()</code>. <code>st_read()</code> requires the file path to
the ESRI <code>shapefile</code>.</p>
<p>Let’s import our AOI:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aoi_boundary_casco</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/casco_aoi/casco_bay_aoi.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `casco_bay_aoi' from data source 
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/maine_gov_maps/casco_aoi/casco_bay_aoi.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1 feature and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -70.2528 ymin: 43.5834 xmax: -69.8387 ymax: 43.9439
Geodetic CRS:  WGS 84</code></pre>
</div>
</section><section id="vector-layer-metadata-attributes"><h2 class="section-heading">Vector Layer Metadata &amp; Attributes<a class="anchor" aria-label="anchor" href="#vector-layer-metadata-attributes"></a>
</h2>
<hr class="half-width">
<p>When we import the <code>casco_bay_aoi.shp</code> vector layer from
an ESRI <code>shapefile</code> into R (as our
<code>aoi_boundary_casco</code> object), the <code>st_read()</code>
function automatically stores information about the data. We are
particularly interested in the geospatial metadata, describing the
format, CRS, extent, and other components of the vector data, and the
attributes which describe properties associated with each individual
vector object.</p>
<div id="data-tip" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip<a class="anchor" aria-label="anchor" href="#data-tip"></a>
</h3>
<div class="callout-content">
<p>The <a href="07-vector-shapefile-attributes-in-r/">Explore and Plot
by Vector Layer Attributes</a> episode provides more information on both
metadata and attributes and using attributes to subset and plot
data.</p>
</div>
</div>
</div>
</section><section id="spatial-metadata"><h2 class="section-heading">Spatial Metadata<a class="anchor" aria-label="anchor" href="#spatial-metadata"></a>
</h2>
<hr class="half-width">
<p>Key metadata for all vector layers includes:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Object Type:</strong> the class of the imported object.</li>
<li>
<strong>Coordinate Reference System (CRS):</strong> the projection
of the data.</li>
<li>
<strong>Extent:</strong> the spatial extent (i.e. geographic area
that the vector layer covers) of the data. Note that the spatial extent
for a vector layer represents the combined extent for all individual
objects in the vector layer.</li>
</ol>
<p>We can view metadata of a vector layer using the
<code>st_geometry_type()</code>, <code>st_crs()</code> and
<code>st_bbox()</code> functions. First, let’s view the geometry type
for our AOI vector layer:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_geometry_type</span><span class="op">(</span><span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] POLYGON
18 Levels: GEOMETRY POINT LINESTRING POLYGON MULTIPOINT ... TRIANGLE</code></pre>
</div>
<p>Our <code>aoi_boundary_casco</code> is a polygon spatial object. The
18 levels shown below our output list the possible categories of the
geometry type. Now let’s check what CRS this file data is in:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 
  wkt:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]</code></pre>
</div>
<p>Our data in the CRS <strong>WGS 84</strong> (it is EPSG code 4326).
The CRS is critical to interpreting the spatial object’s extent values
as it specifies units. To find the extent of our AOI, we can use the
<code>st_bbox()</code> function:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    xmin     ymin     xmax     ymax 
-70.2528  43.5834 -69.8387  43.9439 </code></pre>
</div>
<p>The spatial extent of a vector layer or R spatial object represents
the geographic “edge” or location that is the furthest north, south east
and west. Thus it represents the overall geographic coverage of the
spatial object. Image Source: National Ecological Observatory Network
(NEON).</p>
<figure><img src="fig/dc-spatial-vector/spatial_extent.png" alt="Extent image" class="figure mx-auto d-block"></figure><p>Lastly, we can view all of the metadata and attributes for this R
spatial object by printing it to the screen:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aoi_boundary_casco</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Simple feature collection with 1 feature and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -70.2528 ymin: 43.5834 xmax: -69.8387 ymax: 43.9439
Geodetic CRS:  WGS 84
  FID                       geometry
1   0 POLYGON ((-70.2528 43.5834,...</code></pre>
</div>
</section><section id="spatial-data-attributes"><h2 class="section-heading">Spatial Data Attributes<a class="anchor" aria-label="anchor" href="#spatial-data-attributes"></a>
</h2>
<hr class="half-width">
<p>We introduced the idea of spatial data attributes in <a href="https://cobalt-casco.github.io/organization-geospatial/02-intro-vector-data" class="external-link">an
earlier lesson</a>. Now we will explore how to use spatial data
attributes stored in our data to plot different features.</p>
</section><section id="plot-a-vector-layer"><h2 class="section-heading">Plot a vector layer<a class="anchor" aria-label="anchor" href="#plot-a-vector-layer"></a>
</h2>
<hr class="half-width">
<p>Next, let’s visualize the data in our <code>sf</code> object using
the <code>ggplot</code> package. Unlike with raster data, we do not need
to convert vector data to a dataframe before plotting with
<code>ggplot</code>.</p>
<p>We’re going to customize our boundary plot by setting the size,
color, and fill for our plot. When plotting <code>sf</code> objects with
<code>ggplot2</code>, you need to use the <code>coord_sf()</code>
coordinate system.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_casco</span>, linewidth <span class="op">=</span> <span class="fl">3</span>, </span>
<span>          color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Casco Bay AOI Boundary Plot"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/06-vector-open-shapefile-in-r-rendered-plot-shapefile-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-import-line-and-point-vector-layers" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-import-line-and-point-vector-layers" class="callout-inner">
<h3 class="callout-title">Challenge: Import Line and Point Vector
Layers<a class="anchor" aria-label="anchor" href="#challenge-import-line-and-point-vector-layers"></a>
</h3>
<div class="callout-content">
<p>Using the steps above, import the MaineDOT_Public_Roads and
Maine_Boat_Launches_GeoLibrary vector layers into R. Call the
MaineDOT_Public_Roads object <code>roads_maine</code> and the
Maine_Boat_Launches_GeoLibrary <code>boatlaunches_maine</code>.</p>
<p>Answer the following questions:</p>
<ol style="list-style-type: decimal">
<li><p>What type of R spatial object is created when you import each
layer?</p></li>
<li><p>What is the CRS and extent for each object?</p></li>
<li><p>Do the files contain points, lines, or polygons?</p></li>
<li><p>How many spatial objects are in each file?</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Answers</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>First we import the data:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roads_maine</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/maine_gov_maps/MaineDOT_Public_Roads/MaineDOT_Public_Roads.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `MaineDOT_Public_Roads' from data source 
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/maine_gov_maps/MaineDOT_Public_Roads/MaineDOT_Public_Roads.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 100669 features and 30 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: -71.04662 ymin: 43.06728 xmax: -66.95202 ymax: 47.35999
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boatlaunches_maine</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/maine_gov_maps/Maine_Boat_Launches_GeoLibrary/Maine_Boat_Launches_GeoLibrary.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `Maine_Boat_Launches_GeoLibrary' from data source 
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/maine_gov_maps/Maine_Boat_Launches_GeoLibrary/Maine_Boat_Launches_GeoLibrary.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 578 features and 20 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -70.9817 ymin: 43.0859 xmax: -66.9838 ymax: 47.35484
Geodetic CRS:  WGS 84</code></pre>
</div>
<p>Then we check its class:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">class</span><span class="op">(</span><span class="va">roads_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "sf"         "data.frame"</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">class</span><span class="op">(</span><span class="va">boatlaunches_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "sf"         "data.frame"</code></pre>
</div>
<p>We also check the CRS and extent of each object:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">roads_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 
  wkt:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">roads_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-71.04662  43.06728 -66.95202  47.35999 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">boatlaunches_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 
  wkt:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">boatlaunches_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-70.98170  43.08590 -66.98380  47.35484 </code></pre>
</div>
<p>To see the number of objects in each file, we can look at the output
from when we read these objects into R. <code>roads_maine</code>
contains 100669 features (all lines) and <code>boatlaunches_maine</code>
contains 578 points.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Metadata for vector layers include geometry type, CRS, and
extent.</li>
<li>Load spatial objects into R with the <code>st_read()</code>
function.</li>
<li>Spatial objects can be plotted directly with <code>ggplot</code>
using the <code>geom_sf()</code> function. No need to convert to a
dataframe.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-07-vector-shapefile-attributes-in-r"><p>Content from <a href="07-vector-shapefile-attributes-in-r.html">Explore and Plot by Vector Layer Attributes</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/07-vector-shapefile-attributes-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I compute on the attributes of a spatial object?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Query attributes of a spatial object.</li>
<li>Subset spatial objects using specific attribute values.</li>
<li>Plot a vector feature, colored by unique attribute values.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode continues our discussion of vector layer attributes and
covers how to work with vector layer attributes in R. It covers how to
identify and query layer attributes, as well as how to subset features
by specific attribute values. Finally, we will learn how to plot a
feature according to a set of attribute values. We will do this looking
at data regarding <a href="https://maine.hub.arcgis.com/datasets/ca6961a5e23e47cebf4d0370d3e493a0" class="external-link">Seagrass
beds in Casco Bay from 2022</a> provided by the Maine DEP. For full
metadata, <a href="https://www.arcgis.com/sharing/rest/content/items/ca6961a5e23e47cebf4d0370d3e493a0/info/metadata/metadata.xml?format=default&amp;output=html" class="external-link">see
here</a>.</p>
<section id="load-the-data"><h2 class="section-heading">Load the Data<a class="anchor" aria-label="anchor" href="#load-the-data"></a>
</h2>
<hr class="half-width">
<p>We will continue using the <code>sf</code> and <code>ggplot2</code>
packages in this episode. Make sure that you have these packages
loaded.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span></code></pre>
</div>
<p>We will continue to work with the ESRI <code>shapefiles</code>
(vector layers). Let’s start looking at seagrass beds around Casco Bay
from 2022.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># seagrass in 2022</span></span>
<span><span class="va">seagrass_casco_2022</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_seagrass/MaineDEP_Casco_Bay_Seagrass_2022/MaineDEP_Casco_Bay_Seagrass_2022.shp"</span><span class="op">)</span></span></code></pre>
</div>
</section><section id="query-vector-feature-metadata"><h2 class="section-heading">Query Vector Feature Metadata<a class="anchor" aria-label="anchor" href="#query-vector-feature-metadata"></a>
</h2>
<hr class="half-width">
<p>As we discussed in the <a href="06-vector-open-shapefile-in-r/">Open
and Plot Vector Layers in R</a> episode, we can view metadata associated
with an R object using:</p>
<ul>
<li>
<code>st_geometry_type()</code> - The type of vector data stored in
the object.</li>
<li>
<code>nrow()</code> - The number of features in the object</li>
<li>
<code>st_bbox()</code> - The spatial extent (geographic area covered
by) of the object.</li>
<li>
<code>st_crs()</code> - The CRS (spatial projection) of the
data.</li>
</ul>
<p>We started to explore our <code>seagrass_casco_2022</code> object To
see a summary of all of the metadata associated with our
<code>seagrass_casco_2022</code> object, we can view the object with
<code>View(seagrass_casco_2022)</code> or print a summary of the object
itself to the console.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco_2022</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Simple feature collection with 622 features and 15 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -70.24464 ymin: 43.57213 xmax: -69.84399 ymax: 43.93221
Geodetic CRS:  WGS 84
First 10 features:
   OBJECTID Id Name       Acres   Hectares Orth_Cover Cover_Pct Field_Ver
1         1  1   01  0.04456005 0.01803281          1      0-10         Y
2         2  4   02  0.06076669 0.02459141          3     40-70         Y
3         3  6   03  2.56218247 1.03687846          3     40-70         Y
4         4  8   05  0.71816162 0.29062970          3     40-70         Y
5         5  9   06  0.01815022 0.00734513          3     40-70         Y
6         6 10   07  0.33051475 0.13375458          3     40-70         Y
7         7 11   08  0.08088664 0.03273366          1      0-10         Y
8         8 13   09  0.66689055 0.26988103          1      0-10         Y
9         9 14   10  0.03080650 0.01246695          3     40-70         Y
10       10 15   11 12.54074080 5.07505774          4    70-100         Y
   Video_YN                          Video Comment        Species
1         Y                            A03    &lt;NA&gt; Zostera marina
2         Y                            A04    &lt;NA&gt; Zostera marina
3         Y                            A05    &lt;NA&gt; Zostera marina
4         Y                            A07    &lt;NA&gt; Zostera marina
5         Y                            A08    &lt;NA&gt; Zostera marina
6         Y                            A09    &lt;NA&gt; Zostera marina
7         Y                            A10    &lt;NA&gt; Zostera marina
8         Y                            A11    &lt;NA&gt; Zostera marina
9         Y                            A12    &lt;NA&gt; Zostera marina
10        Y A14, A15, A16, A17, SP07, SP08    &lt;NA&gt; Zostera marina
                                 GlobalID  ShapeSTAre ShapeSTLen
1  {7CAB9D54-4BF9-4B91-94D6-4F0EA4AD53C1}   180.32842  102.57257
2  {D5396F39-D508-45CB-BFE0-13A506D4E94C}   245.91500   84.35420
3  {3C1ED4DC-6580-4CAC-9499-32D445019068} 10368.78375  719.04025
4  {6C1395B8-F532-46C6-AFBA-23B14C2F2E02}  2906.29561  315.88722
5  {EDEDAFA1-8605-4FAC-910F-E6E864F51209}    73.45108   34.00204
6  {820DE3B5-BA6E-4415-A110-95F9F94A4F1C}  1337.54527  165.98655
7  {E4E2A155-7B1C-46C3-94B5-6D0E58B1FEBB}   327.33664  112.52478
8  {C7FEF8AC-9BA7-429C-A45B-270E836FBBA1}  2698.81099  295.01388
9  {356C58A4-DB72-445F-83DA-1035C8EAE917}   124.66947   43.47523
10 {C797140E-F9CB-4EA0-9D7C-FBEA50FE9EB2} 50750.58217 1949.02908
                         geometry
1  POLYGON ((-70.20081 43.5722...
2  POLYGON ((-70.20228 43.5869...
3  POLYGON ((-70.20858 43.5909...
4  POLYGON ((-70.21488 43.5924...
5  POLYGON ((-70.21499 43.5931...
6  POLYGON ((-70.21582 43.5963...
7  POLYGON ((-70.21618 43.5964...
8  POLYGON ((-70.21641 43.5971...
9  POLYGON ((-70.21498 43.6063...
10 POLYGON ((-70.22445 43.6425...</code></pre>
</div>
<p>We can use the <code>ncol</code> function to count the number of
attributes associated with a spatial object too. Note that the geometry
is just another column and counts towards the total.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ncol</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 16</code></pre>
</div>
<p>We can view the individual name of each attribute using the
<code>names()</code> function in R:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "OBJECTID"   "Id"         "Name"       "Acres"      "Hectares"  
 [6] "Orth_Cover" "Cover_Pct"  "Field_Ver"  "Video_YN"   "Video"     
[11] "Comment"    "Species"    "GlobalID"   "ShapeSTAre" "ShapeSTLen"
[16] "geometry"  </code></pre>
</div>
<p>We could also view just the first 6 rows of attribute values using
the <code>head()</code> function to get a preview of the data:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Simple feature collection with 6 features and 15 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -70.21582 ymin: 43.57213 xmax: -70.20057 ymax: 43.59667
Geodetic CRS:  WGS 84
  OBJECTID Id Name      Acres   Hectares Orth_Cover Cover_Pct Field_Ver
1        1  1   01 0.04456005 0.01803281          1      0-10         Y
2        2  4   02 0.06076669 0.02459141          3     40-70         Y
3        3  6   03 2.56218247 1.03687846          3     40-70         Y
4        4  8   05 0.71816162 0.29062970          3     40-70         Y
5        5  9   06 0.01815022 0.00734513          3     40-70         Y
6        6 10   07 0.33051475 0.13375458          3     40-70         Y
  Video_YN Video Comment        Species                               GlobalID
1        Y   A03    &lt;NA&gt; Zostera marina {7CAB9D54-4BF9-4B91-94D6-4F0EA4AD53C1}
2        Y   A04    &lt;NA&gt; Zostera marina {D5396F39-D508-45CB-BFE0-13A506D4E94C}
3        Y   A05    &lt;NA&gt; Zostera marina {3C1ED4DC-6580-4CAC-9499-32D445019068}
4        Y   A07    &lt;NA&gt; Zostera marina {6C1395B8-F532-46C6-AFBA-23B14C2F2E02}
5        Y   A08    &lt;NA&gt; Zostera marina {EDEDAFA1-8605-4FAC-910F-E6E864F51209}
6        Y   A09    &lt;NA&gt; Zostera marina {820DE3B5-BA6E-4415-A110-95F9F94A4F1C}
   ShapeSTAre ShapeSTLen                       geometry
1   180.32842  102.57257 POLYGON ((-70.20081 43.5722...
2   245.91500   84.35420 POLYGON ((-70.20228 43.5869...
3 10368.78375  719.04025 POLYGON ((-70.20858 43.5909...
4  2906.29561  315.88722 POLYGON ((-70.21488 43.5924...
5    73.45108   34.00204 POLYGON ((-70.21499 43.5931...
6  1337.54527  165.98655 POLYGON ((-70.21582 43.5963...</code></pre>
</div>
<p>To understand what these columns mean, we can refer back to the <a href="https://www.arcgis.com/sharing/rest/content/items/ca6961a5e23e47cebf4d0370d3e493a0/info/metadata/metadata.xml?format=default&amp;output=html" class="external-link">original
metadata</a> that gives a better description.</p>
<div id="challenge-attributes-for-different-spatial-classes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-attributes-for-different-spatial-classes" class="callout-inner">
<h3 class="callout-title">Challenge: Attributes for Different Spatial
Classes<a class="anchor" aria-label="anchor" href="#challenge-attributes-for-different-spatial-classes"></a>
</h3>
<div class="callout-content">
<p>Explore the attributes associated with the <code>roads_maine</code>
and <code>aoi_boundary_casco</code> spatial objects.</p>
<ol style="list-style-type: decimal">
<li><p>How many attributes does each have?</p></li>
<li><p>What is the maximum speed posted speed limit on any road in
Maine?</p></li>
<li><p>Which of the following is NOT an attribute of the
<code>roads_maine</code> data object?</p></li>
</ol>
<ol style="list-style-type: upper-alpha">
<li>Speed Limit B) County C) Road Length</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Answers</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>To find the number of attributes, we use the <code>ncol()</code>
function:</li>
</ol>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roads_maine</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/maine_gov_maps/MaineDOT_Public_Roads/MaineDOT_Public_Roads.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `MaineDOT_Public_Roads' from data source 
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/maine_gov_maps/MaineDOT_Public_Roads/MaineDOT_Public_Roads.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 100669 features and 30 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: -71.04662 ymin: 43.06728 xmax: -66.95202 ymax: 47.35999
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ncol</span><span class="op">(</span><span class="va">roads_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 31</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Ownership information is in a column named
<code>Ownership</code>:</li>
</ol>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">max</span><span class="op">(</span><span class="va">roads_maine</span><span class="op">$</span><span class="va">speed_lim</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 75</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>To see a list of all of the attributes, we can use the
<code>names()</code> function:</li>
</ol>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">roads_maine</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "OBJECTID"   "link_id"    "faadt"      "aadt_type"  "fed_urbrur"
 [6] "strtname"   "capacity"   "jurisdictn" "num_lanes"  "offic_mile"
[11] "st_urbrur"  "fedfunccls" "speed_lim"  "speedsrc"   "nhs_status"
[16] "priority"   "prirtecode" "prim_bmp"   "prim_emp"   "prirtename"
[21] "segment_id" "sh_sa_ir"   "townname"   "towncode"   "cntyname"  
[26] "cnty_no"    "surfc_type" "dot_region" "dot_regi_1" "Shape_Leng"
[31] "geometry"  </code></pre>
</div>
<p>“Road Length” is not an attribute of this object.</p>
</div>
</div>
</div>
</div>
</section><section id="explore-values-within-one-attribute"><h2 class="section-heading">Explore Values within One Attribute<a class="anchor" aria-label="anchor" href="#explore-values-within-one-attribute"></a>
</h2>
<hr class="half-width">
<p>We can explore individual values stored within a particular
attribute. Comparing attributes to a spreadsheet or a data frame, this
is similar to exploring values in a column. We did this with the
<code>gapminder</code> dataframe in <a href="https://cobalt-casco.github.io/r-intro-geospatial/05-data-subsetting/index.html" class="external-link">an
earlier lesson</a>. For spatial objects, we can use the same syntax:
<code>objectName$attributeName</code>.</p>
<p>First, what do we have to work with?</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "OBJECTID"   "Id"         "Name"       "Acres"      "Hectares"  
 [6] "Orth_Cover" "Cover_Pct"  "Field_Ver"  "Video_YN"   "Video"     
[11] "Comment"    "Species"    "GlobalID"   "ShapeSTAre" "ShapeSTLen"
[16] "geometry"  </code></pre>
</div>
<p>To see only unique values within the <code>Cover_Pct</code> field, we
can use the <code>unique()</code> function for extracting the possible
values of a character variable (R also is able to handle categorical
variables called factors; we worked with factors a little bit in <a href="https://datacarpentry.org/r-intro-geospatial/03-data-structures-part1/index.html" class="external-link">an
earlier lesson</a>.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">$</span><span class="va">Cover_Pct</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "0-10"   "40-70"  "70-100" "10-40" </code></pre>
</div>
<div class="section level3">
<h3 id="subset-features">Subset Features<a class="anchor" aria-label="anchor" href="#subset-features"></a>
</h3>
<p>We can use the <code>filter()</code> function from <code>dplyr</code>
that we worked with in <a href="https://datacarpentry.org/r-intro-geospatial/06-dplyr" class="external-link">an earlier
lesson</a> to select a subset of features from a spatial object in R,
just like with data frames.</p>
<p>For example, we might be interested only in features that are of
<code>Hectares</code> greater than 25. Once we subset out this data, we
can use it as input to other code so that code only operates on the
footpath lines.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">large_beds</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco_2022</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">Hectares</span> <span class="op">&gt;</span> <span class="fl">25</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">nrow</span><span class="op">(</span><span class="va">large_beds</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 4</code></pre>
</div>
<p>Our subsetting operation reduces the <code>features</code> count 4
93. This means that 4 polygons in our spatial object are larger than 25
Hectares. We can plot only these big beds</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">large_beds</span>, fill <span class="op">=</span> <span class="st">"lightgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"2022 Seagrass Beds"</span>, subtitle <span class="op">=</span> <span class="st">"Large Beds Only"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-plot-subset-shapefile-1.png" alt="Map of the large beds in the study area." class="figure mx-auto d-block"><figcaption>
Map of the large beds in the study area.
</figcaption></figure><p>There are four features in our large beds subset. But we don’t have
any more information than that they are large. Let’s adjust the colors
used in our plot. If we have 4 features in our vector object, we can
plot each using a unique color by assigning a column name to the color
aesthetic (<code>fill =</code>). We use the syntax
<code>aes(fill = )</code> to do this. Let’s look at
<code>Cover_Pct</code> to differentiate sparse from dense beds.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">large_beds</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Percent Cover of Seagrass'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"2022 Seagrass Beds"</span>, subtitle <span class="op">=</span> <span class="st">"Sparse Beds Only"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-plot-subset-shapefile-unique-colors-1.png" alt="Map of the large beds where they are classified by percent cover." class="figure mx-auto d-block"><figcaption>
Map of the large beds where they are classified by percent cover.
</figcaption></figure><p>Now, we see that there are in some dense and some sparse beds that
are big.</p>
<div id="challenge-subset-spatial-line-objects" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-subset-spatial-line-objects" class="callout-inner">
<h3 class="callout-title">Challenge: Subset Spatial Line Objects<a class="anchor" aria-label="anchor" href="#challenge-subset-spatial-line-objects"></a>
</h3>
<div class="callout-content">
<p>Subset out all of the roads with
<code>cntyname == "Cumberland"</code> county and plot it with the color
showing the <code>townname</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Answers</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>First we will save an object with only the roads in Cumberland:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cumberland_roads</span> <span class="op">&lt;-</span> <span class="va">roads_maine</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">cntyname</span> <span class="op">==</span> <span class="st">"Cumberland"</span><span class="op">)</span></span></code></pre>
</div>
<p>Let’s check how many features there are in this subset:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">nrow</span><span class="op">(</span><span class="va">cumberland_roads</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 18246</code></pre>
</div>
<p>Now let’s plot that data:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">cumberland_roads</span>, </span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">townname</span><span class="op">)</span>,</span>
<span>          size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Cumberland County"</span>, subtitle <span class="op">=</span> <span class="st">"Roads"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-boardwalk-map-1.png" alt="Map of the boardwalks in the study area." class="figure mx-auto d-block"><figcaption>
Map of the boardwalks in the study area.
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="challenge-subset-spatial-polygon-objects-and-plotting" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-subset-spatial-polygon-objects-and-plotting" class="callout-inner">
<h3 class="callout-title">Challenge: Subset Spatial Polygon Objects and
Plotting<a class="anchor" aria-label="anchor" href="#challenge-subset-spatial-polygon-objects-and-plotting"></a>
</h3>
<div class="callout-content">
<p>Are dense beds large or small? From <code>seagrass_casco_2022</code>,
subset out only the dense beds - <code>Cover_Pct == "70-100"</code>.</p>
<ol style="list-style-type: decimal">
<li><p>How many dense beds are there?</p></li>
<li><p>What is the distribution of their size?</p></li>
<li><p>Plotthem . To make it interesting, set the color (not the fill)
to map to <code>Hectares</code> so that we can see where big dense beds
exist. To further assist with this A) you will need to set
<code>linewidth = 2</code>, as otherwise you won’t be able to see the
beds well and B) you’ll need to use a binned color scale, like we did
with rasters. I’m a fan of <code>scale_color_viridis_b()</code> here,
but also feel free to try some options from
<code>scale_color_fermenter()</code> or play with the
<code>n.bins</code> argument.</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Answer</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>First we will save an object with only the stone wall lines and
check the number of features:</li>
</ol>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_beds</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco_2022</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">Cover_Pct</span> <span class="op">==</span> <span class="st">"70-100"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">nrow</span><span class="op">(</span><span class="va">dense_beds</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 79</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Is the distribution different than the size of all beds? Let’s
see.</li>
</ol>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dense_beds</span>,</span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Hectares</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/07-vector-shapefile-attributes-in-r-rendered-unnamed-chunk-7-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>It’s roughly similar, although there seem to be more mid-size
beds.</p>
<ol start="3" style="list-style-type: decimal">
<li>Last, we can plot the data:</li>
</ol>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dense_beds</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Hectares</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Casco Seagrass Beds in 2022"</span>, subtitle <span class="op">=</span> <span class="st">"70-100% Cover"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_b</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-stone-wall-map-1.png" alt="Map of the dense seagrass beds where beds are colored by size in hectares." class="figure mx-auto d-block"><figcaption>
Map of the dense seagrass beds where beds are colored by size in
hectares.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section><section id="customize-plots"><h2 class="section-heading">Customize Plots<a class="anchor" aria-label="anchor" href="#customize-plots"></a>
</h2>
<hr class="half-width">
<p>In the examples above, <code>ggplot()</code> automatically selected
colors for each line based on a default color order. If we don’t like
those default colors, we can create a vector of colors - one for each
feature.</p>
<p>First we will check how many unique levels our factor has:</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">$</span><span class="va">Cover_Pct</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "0-10"   "40-70"  "70-100" "10-40" </code></pre>
</div>
<p>Then we can create a palette of four colors, one for each feature in
our vector object.</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bed_colors</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"purple"</span>, <span class="st">"lightgreen"</span>, <span class="st">"orange"</span><span class="op">)</span></span></code></pre>
</div>
<p>We can tell <code>ggplot</code> to use these colors when we plot the
data.</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>, </span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Cover_Pct</span>, fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Casco Bay Seagrass Beds in 2022"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-paths-map-1.png" alt="Roads and trails in the area." class="figure mx-auto d-block"><figcaption>
Roads and trails in the area.
</figcaption></figure><div class="section level3">
<h3 id="improve-our-plot-legend">Improve Our Plot Legend<a class="anchor" aria-label="anchor" href="#improve-our-plot-legend"></a>
</h3>
<p>Let’s improve the legend of our plot. We’ve already created a
legenend for <code>Cover_Pct</code> by default. Let’s start by making
the title be readable using <code>labs()</code> to give it titles. Note,
color and fill must have the same title, otherwise the legend
splits.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>, </span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Cover_Pct</span>, fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'% Cover of Seagrass'</span>, fill <span class="op">=</span> <span class="st">"% Cover of Seagrass"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Casco Bay Seagrass Beds in 2022"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/07-vector-shapefile-attributes-in-r-rendered-add-legend-to-plot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We can change the appearance of our legend by manually setting
different parameters using the <code>theme()</code> function.</p>
<ul>
<li>
<code>legend.title</code>: change the legend title font size</li>
<li>
<code>legend.text</code>: change the legend text font size</li>
<li>
<code>legend.box.background</code>: add an outline box</li>
<li>
<code>legend.position</code>: where you want the legend. Options
include “none”, “left”, “right”, “bottom”, “top”, or two-element numeric
vector.</li>
</ul>
<p>Note, some of these will need an <code>element_*()</code> function.
To dig deep deep into plot customization, see <code>?theme</code></p>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>, </span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Cover_Pct</span>, fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'% Cover of Seagrass'</span>, fill <span class="op">=</span> <span class="st">"% Cover of Seagrass"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Casco Bay Seagrass Beds in 2022"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>        legend.box.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-modify-legend-plot-1.png" alt="Map of the beds in the 2022 area with large-font and border around the legend." class="figure mx-auto d-block"><figcaption>
Map of the beds in the 2022 area with large-font and border around the
legend.
</figcaption></figure><p><code>theme_minimal()</code> here is a premade ggplot2 theme. You can
also use <code>theme()</code> to make your own customized themes.</p>
<div id="challenge-visualizing-change" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-visualizing-change" class="callout-inner">
<h3 class="callout-title">Challenge: Visualizing Change<a class="anchor" aria-label="anchor" href="#challenge-visualizing-change"></a>
</h3>
<div class="callout-content">
<p>Create a similar plot from the 2023 data. There are some differences.
<code>Cover_Pct</code> is slightly different. You’ll have to filter out
the <code>"</code>0%“` beds in order to use the identical color palette
(a good idea in order to see change).</p>
<p>Do you see differences between 2013 and 2022?</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">Answers</h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<p>First we explore load and filter the data.</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco_2013</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/maine_gov_seagrass/MaineDEP_Casco_Bay_Eelgrass_2013/"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">Cover_Pct</span> <span class="op">!=</span> <span class="st">"0%"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `MaineDEP_Casco_Bay_Eelgrass_2013' from data source 
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/maine_gov_seagrass/MaineDEP_Casco_Bay_Eelgrass_2013' 
  using driver `ESRI Shapefile'
Simple feature collection with 1056 features and 7 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -70.2477 ymin: 43.5896 xmax: -69.84402 ymax: 43.93288
Geodetic CRS:  WGS 84</code></pre>
</div>
<p>Then, honestly, we can re-use the same plotting code as above.</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2013</span>, </span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Cover_Pct</span>, fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'% Cover of Seagrass'</span>, fill <span class="op">=</span> <span class="st">"% Cover of Seagrass"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Casco Bay Seagrass Beds in 2013"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>        legend.box.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-paths-bike-horses-1.png" alt="2013 Seagrass Beds in Casco Bay." class="figure mx-auto d-block"><figcaption>
2013 Seagrass Beds in Casco Bay.
</figcaption></figure><p>Flip back and forth between the two maps. Qualitatively, it looks
like beds are less dense.</p>
</div>
</div>
</div>
</div>
<div id="data-tip" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip<a class="anchor" aria-label="anchor" href="#data-tip"></a>
</h3>
<div class="callout-content">
<p>You can plot multiple plot panels next to each other using the <a href="https://patchwork.data-imaginist.com/" class="external-link">patchwork</a> library.</p>
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">patchwork</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beds_2013</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2013</span>, </span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Cover_Pct</span>, fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'% Cover of Seagrass'</span>, fill <span class="op">=</span> <span class="st">"% Cover of Seagrass"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Casco Bay Seagrass Beds in 2013"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">beds_2022</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>, </span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Cover_Pct</span>, fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">bed_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Casco Bay Seagrass Beds in 2022"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># the patchwork - note removing one legend for ease of viz</span></span>
<span><span class="co"># as they are the same but different text</span></span>
<span><span class="op">(</span><span class="va">beds_2013</span> <span class="op">&amp;</span> <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="op">(</span><span class="va">beds_2022</span> <span class="op">&amp;</span> <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span><span class="op">)</span>  </span></code></pre>
</div>
<figure><img src="fig/07-vector-shapefile-attributes-in-r-rendered-patchwork-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Spatial objects in <code>sf</code> are similar to standard data
frames and can be manipulated using the same functions.</li>
<li>Almost any feature of a plot can be customized using the various
functions and options in the <code>ggplot2</code> package.</li>
</ul>
</div>
</div>
</div>
</div>
</section></section><section id="aio-08-vector-plot-shapefiles-custom-legend"><p>Content from <a href="08-vector-plot-shapefiles-custom-legend.html">Plot Multiple Vector Layers</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/08-vector-plot-shapefiles-custom-legend.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I make different vecotr layers line up?</li>
<li>How can I plot multiple forms of vector data together?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Plot multiple vector layers in the same plot.</li>
<li>Apply custom symbols to spatial objects in a plot.</li>
<li>Create a multi-layered plot with raster and vector data.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode builds upon <a href="07-vector-shapefile-attributes-in-r/">the previous episode</a> to
work with vector layers in R and explore how to plot multiple vector
layers. It also covers how to plot raster and vector data together on
the same plot.</p>
<section id="load-the-data"><h2 class="section-heading">Load the Data<a class="anchor" aria-label="anchor" href="#load-the-data"></a>
</h2>
<hr class="half-width">
<p>To work with vector data in R, we can use the <code>sf</code>
library. We will also be using <code>ggplot2</code> and some
<code>dplyr</code>. Let’s start by loading them.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span></code></pre>
</div>
<p>We are going to plot the 2022 Casco Bay Seagrass Beds, but, include
some coastline for context. We will also add layers of information along
the way. To start with, let’s load up the seagrass beds, the AOI for
Casco, and a shapefile of counties in Maine.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aoi_boundary_casco</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/casco_aoi/casco_bay_aoi.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_casco_2022</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_seagrass/MaineDEP_Casco_Bay_Seagrass_2022/MaineDEP_Casco_Bay_Seagrass_2022.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">maine_borders</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/Maine_State_Boundary_Polygon_Feature/Maine_State_Boundary_Polygon_Feature.shp"</span><span class="op">)</span></span></code></pre>
</div>
</section><section id="making-sure-layers-match-in-extent"><h2 class="section-heading">Making Sure Layers Match in Extent<a class="anchor" aria-label="anchor" href="#making-sure-layers-match-in-extent"></a>
</h2>
<hr class="half-width">
<p>One of the beautiful things about <code>ggplot2</code> is that we’re
going to be able to just add layers together to make a nice plot. Our
goal here is to plot seagrass beds with a coastline bordering them, so
we can see how they line up around islands. However, we have a small
problem. Let’s compare the extent of our objects using
<code>st_bbox()</code>.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    xmin     ymin     xmax     ymax 
-70.2528  43.5834 -69.8387  43.9439 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-70.24464  43.57213 -69.84399  43.93221 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">maine_borders</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-71.08392  42.97703 -66.94942  47.45986 </code></pre>
</div>
<p>While the first two are close - indeed, the AOI was made from the
seagrass polygons extent - the state of Maine is huge relative to Casco
Bay. We need to <strong>crop</strong> that shapefile down to just the
area we want to plot. Fortunately, <code>sf</code> features a function
called <code>st_crop()</code> which will crop a large vector file down
to the size of the extent of a smaller vector file. So if we just want
the Casco Coastline, we can crop <code>maine_borders</code> down to the
size of the <code>aoi_boundary_casco</code> vector file.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">casco_coastline</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">maine_borders</span>, <span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in wk_handle.wk_wkb(wkb, s2_geography_writer(oriented = oriented, : Loop 0 is not valid: Edge 47287 has duplicate vertex with edge 47329</code></pre>
</div>
<p>This does not always go well with data sets from the wild. Without
getting too deep into it, vector files (particularly polygons) can have
a variety of issues in them which make them invalid. To fix this, we
need to make them valid before cropping with
<code>st_make_valid()</code>. Odd, but, this is incredibly common.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">casco_coastline</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">maine_borders</span> <span class="op">|&gt;</span> <span class="fu">st_make_valid</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                           <span class="va">aoi_boundary_casco</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_coastline</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-crop-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="casco-bay-region-roads" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="casco-bay-region-roads" class="callout-inner">
<h3 class="callout-title">Casco Bay Region Roads<a class="anchor" aria-label="anchor" href="#casco-bay-region-roads"></a>
</h3>
<div class="callout-content">
<p>Load up the roads of Maine and crop them to the Casco Bay region.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roads_maine</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/maine_gov_maps/MaineDOT_Public_Roads/MaineDOT_Public_Roads.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `MaineDOT_Public_Roads' from data source 
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/maine_gov_maps/MaineDOT_Public_Roads/MaineDOT_Public_Roads.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 100669 features and 30 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: -71.04662 ymin: 43.06728 xmax: -66.95202 ymax: 47.35999
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roads_casco</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">roads_maine</span>, <span class="va">aoi_boundary_casco</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads_casco</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-load_crop_roads-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<p>Lovely! Now let’s start bringing seagrass in.</p>
</section><section id="plotting-multiple-vector-layers"><h2 class="section-heading">Plotting Multiple Vector Layers<a class="anchor" aria-label="anchor" href="#plotting-multiple-vector-layers"></a>
</h2>
<hr class="half-width">
<p>In the <a href="07-vector-shapefile-attributes-in-r/">previous
episode</a>, we learned how to plot information from a single vector
layer and do some plot customization including adding a custom legend.
However, what if we want to create a more complex plot with many vector
layers and unique symbols that need to be represented clearly in a
legend?</p>
<p>Now, let’s create a plot that combines our seagrass beds
(<code>seagrass_casco_2022</code>), the coastline
(<code>casco_coastline</code>) and roads (<code>roads_maine</code>)
spatial objects. We will need to build a custom legend as well.</p>
<p>To begin, we will create a plot with the coastline as the base layer
with a tan fill and a black outline. We will add on top roads, but with
alpha = 0.1 so they are faint. Last, we will layer seagrass beds on top
with color and fill as percent cover and a linewidth of 1.3. We will
save it as an object so we can make small changes from here on out.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_map</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_coastline</span>, fill <span class="op">=</span> <span class="st">"tan"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads_casco</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>, </span>
<span>          mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Cover_Pct</span>,</span>
<span>                        fill <span class="op">=</span> <span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greens"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greens"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">seagrass_map</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-plot-many-shapefiles-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>This looks OK, but, let’s dial things up a bit. Let’s</p>
<ol style="list-style-type: decimal">
<li>Eliminate the gap around the plot with an argument
<code>expand = FALSE</code> to <code>coord_sf()</code>.</li>
<li>Give it a cleaner theme with <code>theme_classic()</code>
</li>
<li>Give the map a name and the fill/color legend a name.</li>
<li>Use <code>theme()</code> to make it more ocean-y with a</li>
</ol>
<p>We can start by making the plot cleaner and eliminating the gap (1
&amp; 2)</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_map</span> <span class="op">&lt;-</span> <span class="va">seagrass_map</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_map</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-plot-custom-shape-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Now lets adjust the legend titles by using <code>labs()</code>.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_map</span> <span class="op">&lt;-</span> <span class="va">seagrass_map</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"% Cover"</span>, fill <span class="op">=</span> <span class="st">"% Cover"</span>, </span>
<span>       title <span class="op">=</span> <span class="st">"Seagrass in Casco Bay in 2022"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_map</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-create-custom-legend-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Last, we can use <code>theme()</code> to add a light blue background
and rotate the X axis. We will save this as an object, so we don’t need
to type more as we make further modifications.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_map</span> <span class="op">&lt;-</span> <span class="va">seagrass_map</span>  <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_map</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-better_theme-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section id="zooming-in"><h2 class="section-heading">Zooming In<a class="anchor" aria-label="anchor" href="#zooming-in"></a>
</h2>
<hr class="half-width">
<p>This map looks great, but, there’s a lot of data here. While it can
provide a great big-picture overview, it’s hard to see more small-scale
features. There are two solutions to this. The first is plotting the map
zoomed in to an area of interest. You can get your AOI either by
eyeballing the corner coordinates (x and y min and max) from the plot
itself, or use something like <a href="https://maps.google.com" class="external-link">https://maps.google.com</a> and right
click to get point coordinates.</p>
<p>Using the later method, here, for example, is the area around
Mackworth Island.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_map</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="op">-</span><span class="fl">70.24768051612979</span>, <span class="op">-</span><span class="fl">70.19432151530208</span><span class="op">)</span>,</span>
<span>           ylim <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">43.66353031177649</span>, <span class="fl">43.714022044471584</span><span class="op">)</span>,</span>
<span>           expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-coord_sf_zoom-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The second answer is an interactive map with leaflet. This is
slightly more challenging to implement, but very similar to what we did
with rasters before. We will start by making a color palette for the
map. We can use <code>colorFactor()</code> as we have discrete classes
here.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_pal</span> <span class="op">&lt;-</span> <span class="fu">colorFactor</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greens"</span>,</span>
<span>                         domain <span class="op">=</span> <span class="va">seagrass_casco_2022</span><span class="op">$</span><span class="va">Cover_Pct</span><span class="op">)</span></span></code></pre>
</div>
<p>From here, we can build a leaflet map. Let’s use
<code>addProviderTiles("Stadia.AlidadeSmooth")</code> for a very neutral
background. We add <code>sf</code> polygons using
<code>addPolygons()</code>. For this, we need to think about the what is
creating polygon borders and the fill. We will set
<code>stroke = FALSE</code> so we don’t have to worry about the border
(too many more argument) and instead use our palette - which is now a
function to be evaluated with <code>~</code> and set a
<code>fillOpacity</code> to 1, for fully opaque.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span> <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Stadia.AlidadeSmooth"</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>, </span>
<span>              fillColor <span class="op">=</span> <span class="op">~</span><span class="fu">seagrass_pal</span><span class="op">(</span><span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>              fillOpacity <span class="op">=</span> <span class="fl">1</span>,</span>
<span>              stroke <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-leaflet_map-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Note, you can recreate what you did with the <code>ggplot2</code>
above just using the <code>sf objects</code>. We’ll need to invoke one
trick from the <code>leaflet.extras</code> package to get that blue
background.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet.extras</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_coastline</span>, </span>
<span>              fillColor <span class="op">=</span> <span class="st">"tan"</span>,</span>
<span>              fillOpacity <span class="op">=</span> <span class="fl">1</span>,</span>
<span>              stroke <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolylines</span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads_casco</span>,</span>
<span>               color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>               opacity <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>               weight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>, </span>
<span>              fillColor <span class="op">=</span> <span class="op">~</span><span class="fu">seagrass_pal</span><span class="op">(</span><span class="va">Cover_Pct</span><span class="op">)</span>,</span>
<span>              fillOpacity <span class="op">=</span> <span class="fl">1</span>,</span>
<span>              stroke <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_casco</span>,</span>
<span>              color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>              fillOpacity <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">setMapWidgetStyle</span><span class="op">(</span><span class="fu">list</span><span class="op">(</span>background<span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addLegend</span><span class="op">(</span>pal <span class="op">=</span> <span class="va">seagrass_pal</span>, </span>
<span>            values <span class="op">=</span> <span class="va">seagrass_casco_2022</span><span class="op">$</span><span class="va">Cover_Pct</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"% Cover Seagrass"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-leaflet_custom-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-lets-part-like-its-1997-er-1993-1994" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-lets-part-like-its-1997-er-1993-1994" class="callout-inner">
<h3 class="callout-title">Challenge: Let’s Part Like it’s 1997… er,
1993-1994<a class="anchor" aria-label="anchor" href="#challenge-lets-part-like-its-1997-er-1993-1994"></a>
</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>The earliest seagrass datat available from Maine’s Geolibrary is
their <a href="https://maine.hub.arcgis.com/datasets/maine::mainedmr-eelgrass-1997/about" class="external-link">1997
State-Wide Data</a> aggregated from photography from 1992 - 1997. Load
up the ESRI <code>shapefile</code> from
<code>data/maine_gov_seagrass/MaineDMR_-_Eelgrass-1997-shp</code> and do
a quick visualization showing where was surveyed when.</p></li>
<li><p>Crop it down to Casco Bay and make a plot showing the area around
Mackworth Island. Make sure your title reflects what years are being
represented. While there is a cover classification (from 0-5) based on
percent cover, the metadata doesn’t have the lineup. Still,
qualitatively, how does this compare to 2022? Use whatever technique
you’d like to visualize this small area. Note, <code>COVER</code> is
continuous, so to make it into distinct classes you will need
<code>as.character(COVER)</code> in your code.</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Answers</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>First we need to load in the data. Let’ see how many years are
here.</li>
</ol>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_1997</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/maine_gov_seagrass/MaineDMR_-_Eelgrass-1997-shp/MaineDMR_-_Eelgrass.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `MaineDMR_-_Eelgrass' from data source 
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/maine_gov_seagrass/MaineDMR_-_Eelgrass-1997-shp/MaineDMR_-_Eelgrass.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 7519 features and 10 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -70.82449 ymin: 43.05945 xmax: -66.98462 ymax: 45.11247
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># what are the names</span></span>
<span><span class="fu">names</span><span class="op">(</span><span class="va">seagrass_1997</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "OBJECTID_1" "OBJECTID"   "COVER"      "LOCATION"   "ACRES"     
 [6] "HECTARES"   "Year97"     "GlobalID"   "Shape__Are" "Shape__Len"
[11] "geometry"  </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># what are the unique years</span></span>
<span><span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_1997</span><span class="op">$</span><span class="va">Year97</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1993 1994 1997 1996 1992 1995</code></pre>
</div>
<p>Then, we can visualize.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_1997</span>,</span>
<span>          <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Year97</span>, fill <span class="op">=</span> <span class="va">Year97</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> </span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-unnamed-chunk-2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><ol start="2" style="list-style-type: decimal">
<li>For the second piece, first, we need to crop to Casco Bay and check
what years this data consists of.</li>
</ol>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco_1997</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">seagrass_1997</span> <span class="op">|&gt;</span> <span class="fu">st_make_valid</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                              <span class="va">aoi_boundary_casco</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco_1997</span><span class="op">$</span><span class="va">Year97</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1994 1993</code></pre>
</div>
<p>With the cropped polygons, we can make a map akin to what we did
above for 2022. We can even re-use our code, but with a few small
modifications for a different data set and a different cover type.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_coastline</span>, fill <span class="op">=</span> <span class="st">"tan"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads_casco</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_1997</span>, </span>
<span>          mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">as.character</span><span class="op">(</span><span class="va">COVER</span><span class="op">)</span>,</span>
<span>                        fill <span class="op">=</span> <span class="fu">as.character</span><span class="op">(</span><span class="va">COVER</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greens"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greens"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Cover Class"</span>, fill <span class="op">=</span> <span class="st">"Cover Class"</span>, </span>
<span>       title <span class="op">=</span> <span class="st">"Seagrass in Casco Bay in 1993 and 1994"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="op">-</span><span class="fl">70.24768051612979</span>, <span class="op">-</span><span class="fl">70.19432151530208</span><span class="op">)</span>,</span>
<span>           ylim <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">43.66353031177649</span>, <span class="fl">43.714022044471584</span><span class="op">)</span>,</span>
<span>           expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-unnamed-chunk-4-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>While we cannot know how the beds compare exactly, given that we do
not know how the Cover Class maps to % Cover, it appears that many of
the beds in 1993 and 1994 are at the highest class of cover, while in
2022 they are at the high-middle.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Use the <code>+</code> operator to add multiple layers to a
ggplot.</li>
<li>Use <code>st_crop()</code> to put spatially subset a vector data
set.</li>
<li>Multi-layered plots can combine multiple vector data sets.</li>
<li>Use <code>leaflet</code> or zooming in <code>ggplot2</code> to see
small spatial features.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-09-vector-when-data-dont-line-up-crs"><p>Content from <a href="09-vector-when-data-dont-line-up-crs.html">Handling Spatial Projection &amp; CRS</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/09-vector-when-data-dont-line-up-crs.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I work with data sets that are in different projections?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Examine objects with different CRSs in the same plot.</li>
<li>Reproject a raster and a vector layer in R.</li>
<li>Plot vector and raster layers in the same plot.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<section id="projection-in-r"><h2 class="section-heading">Projection in R<a class="anchor" aria-label="anchor" href="#projection-in-r"></a>
</h2>
<hr class="half-width">
<p>In <a href="08-vector-plot-shapefiles-custom-legend/">an earlier
episodes</a> we learned how to layer multiple vector data types. These
principles extend to layering in raster data. When combining multiple
data sources, particularly from different agencies or research efforts,
we often find that they do not have the same Coordinate Reference
System. This can be true of combining multiple vectors or rasters, or
both.</p>
<p>We will apply our skills learned thus far to create maps that combine
both the coastline of Casco Bay (<code>casco_coastline</code>) with SST
data from 2022 (<code>b10_casco_2022</code>) and seagrass data
(<code>seagrass_casco_2022</code>). We will learn how to map vector data
sources that are in different CRSs and thus don’t line up on a map.</p>
</section><section id="load-the-data"><h2 class="section-heading">Load the Data<a class="anchor" aria-label="anchor" href="#load-the-data"></a>
</h2>
<hr class="half-width">
<p>We will continue to use the <code>sf</code> and <code>terra</code>
packages in this episode as well as others from previously.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyterra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span></code></pre>
</div>
<p>We will continue to work with the two ESRI <code>shapefiles</code>
that we loaded in the <a href="08-vector-plot-shapefiles-custom-legend/">previously</a> as well
as some Sea Surface Temperature data from <a href="01-raster-structure/">our raster lessons</a>.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Casco Bay SST from Sept 9, 2022</span></span>
<span><span class="va">b10_casco_2022</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span></span>
<span>  <span class="st">"data/landsat_casco/b10_cropped/LC08_L2SP_011030_20220909_20220914_02_T1_ST_B10.TIF"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Seagrass beds in 2022</span></span>
<span><span class="va">seagrass_casco_2022</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_seagrass/MaineDEP_Casco_Bay_Seagrass_2022/MaineDEP_Casco_Bay_Seagrass_2022.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Casco Coastline</span></span>
<span><span class="va">casco_coastline</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/Maine_State_Boundary_Polygon_Feature/Maine_State_Boundary_Polygon_Feature.shp"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_make_valid</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_crop</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
</section><section id="working-with-spatial-data-from-different-sources"><h2 class="section-heading">Working With Spatial Data From Different Sources<a class="anchor" aria-label="anchor" href="#working-with-spatial-data-from-different-sources"></a>
</h2>
<hr class="half-width">
<p>We often need to gather spatial datasets from different sources
and/or data that cover different spatial extents. These data are often
in different Coordinate Reference Systems (CRSs).</p>
<p>Some reasons for data being in different CRSs include:</p>
<ol style="list-style-type: decimal">
<li>The data are stored in a particular CRS convention used by the data
provider (for example, a government agency).</li>
<li>The data are stored in a particular CRS that is customized to a
region. For instance, many states in the US prefer to use a State Plane
projection customized for that state.</li>
</ol>
<figure><img src="fig/map_usa_different_projections.jpg" alt="" class="figure mx-auto d-block"><figcaption>Maps of the United States using data in different
projections. Source: opennews.org, from: <a href="https://media.opennews.org/cache/06/37/0637aa2541b31f526ad44f7cb2db7b6c.jpg" class="external-link uri">https://media.opennews.org/cache/06/37/0637aa2541b31f526ad44f7cb2db7b6c.jpg</a></figcaption></figure><p>Notice the differences in shape associated with each different
projection. These differences are a direct result of the calculations
used to “flatten” the data onto a 2-dimensional map. Often data are
stored purposefully in a particular projection that optimizes the
relative shape and size of surrounding geographic boundaries (states,
counties, countries, etc).</p>
<p>In this episode we will learn how to identify and manage spatial data
in different projections. We will learn how to reproject the data so
that they are in the same projection to support plotting / mapping. Note
that these skills are also required for any geoprocessing / spatial
analysis. Data need to be in the same CRS to ensure accurate
results.</p>
</section><section id="inspecting-crs"><h2 class="section-heading">Inspecting CRS<a class="anchor" aria-label="anchor" href="#inspecting-crs"></a>
</h2>
<hr class="half-width">
<p>To begin, how different are these two data sources? We can inspect
their respective Coordinate Reference Systems to see.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">b10_casco_2022</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=utm +zone=19 +datum=WGS84 +units=m +no_defs"</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">casco_coastline</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=longlat +datum=WGS84 +no_defs"</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># st_crs(casco_coastline)$proj4string #this also works</span></span></code></pre>
</div>
<p>Our project string for <code>b10_casco_2022</code> specifies the UTM
projection as follows:</p>
<p><code>+proj=utm +zone=19 +datum=WGS84 +units=m +no_defs</code></p>
<ul>
<li>
<strong>proj=utm:</strong> the projection is UTM, UTM has several
zones.</li>
<li>
<strong>zone=19:</strong> the zone is 19</li>
<li>
<strong>datum=WGS84:</strong> the datum WGS84 (the datum refers to
the 0,0 reference for the coordinate system used in the projection)</li>
<li>
<strong>units=m:</strong> the units for the coordinates are in
METERS.</li>
<li>
<strong>no_defs:</strong> nothing is used from detault files.</li>
</ul>
<p>Note that the <code>zone</code> is unique to the UTM projection. Not
all CRSs will have a zone.</p>
<p>For <code>casco_coastline</code></p>
<p>Our project string for <code>casco_coastline</code> specifies the
lat/long projection as follows:</p>
<p><code>+proj=longlat +datum=WGS84 +no_defs</code></p>
<ul>
<li>
<strong>proj=longlat:</strong> the data are in a geographic
(latitude and longitude) coordinate system</li>
<li>
<strong>datum=WGS84:</strong> the datum WGS84 (the datum refers to
the 0,0 reference for the coordinate system used in the projection)</li>
<li>
<strong>no_defs:</strong> nothing is used from detault files.</li>
</ul>
<p>Note that there are no specified units above. This is because this
geographic coordinate reference system is in latitude and longitude
which is most often recorded in decimal degrees.</p>
<p>Sometimes you will also see <strong>ellps=WGS84:</strong> the
ellipsoid (how the earth’s roundness is calculated) is WGS84.</p>
<p>The projections are very different. Refer to UTM versus UTM in the
figure of the US above.</p>
<div id="data-tip" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip<a class="anchor" aria-label="anchor" href="#data-tip"></a>
</h3>
<div class="callout-content">
<p>the last portion of each <code>proj4</code> string could potentially
be something like <code>+towgs84=0,0,0</code>. This is a conversion
factor that is used if a datum conversion is required. We will not deal
with datums in this episode series.</p>
</div>
</div>
</div>
</section><section id="do-we-need-to-reproject"><h2 class="section-heading">Do We Need to Reproject?<a class="anchor" aria-label="anchor" href="#do-we-need-to-reproject"></a>
</h2>
<hr class="half-width">
<p>We can begin by trying to plot these datasets together. One of the
nice things about <code>tidyterra</code> and how <code>ggplot2</code>
works with <code>sf</code> objects is that it projects them to the same
CRS. So, if we try and plot these data sources together:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2022</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_coastline</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> </span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-try-plot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>This looks pretty good. Leaflet looks good as well.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_coastline</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"white"</span>, weight <span class="op">=</span> <span class="fl">1</span>, </span>
<span>              color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span><span class="va">b10_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-unnamed-chunk-2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>But, note two things. First, not every plotting algorithm will work.
For example if we went old school and used <code>plot()</code> with
<code>add=TRUE</code> to add a layer, this would have failed. Here we
see if putting a different layer down as the base.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">par</span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot</span><span class="op">(</span><span class="va">b10_casco_2022</span>, main <span class="op">=</span> <span class="st">"SST First"</span><span class="op">)</span></span>
<span><span class="fu">plot</span><span class="op">(</span><span class="va">casco_coastline</span><span class="op">$</span><span class="va">geometry</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot</span><span class="op">(</span><span class="va">casco_coastline</span><span class="op">$</span><span class="va">geometry</span>, main <span class="op">=</span> <span class="st">"Coastline First"</span>, axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">plot</span><span class="op">(</span><span class="va">b10_casco_2022</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-old-school-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">par</span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Where did the other layer go? The axes give away that it’s a
projection problem.</p>
<p>Second, in both of these, the borders and the raster don’t line up.
So we want to line up extents. This is an aesthetic concern, but can be
a big one - particularly if we were doing operations other than
plotting. We need to crop one data set by the other.</p>
</section><section id="cropping-and-crs"><h2 class="section-heading">Cropping and CRS<a class="anchor" aria-label="anchor" href="#cropping-and-crs"></a>
</h2>
<hr class="half-width">
<p>Cropping involves cutting off one part of an object to match another.
It is one of the operations we use to subset data spatially. We can also
extend objects to add rows or columns or mask out parts of an object. In
this case, let’s crop <code>b10_casco_2022</code> so that we get rid of
that NA edge. After, we can crop the the coastline in order to eliminate
that weird hang-on piece of coast at the bottom of the maps.</p>
<p>As we are cropping a <code>terra</code> <code>SpatRaster</code>
object, we will use <code>crop()</code> which takes an input raster and
then an object with an extent to crop it to.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2022_cropped</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span><span class="va">b10_casco_2022</span>, </span>
<span>                               <span class="va">casco_coastline</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error: [crop] extents do not overlap</code></pre>
</div>
<p>Well that’s odd. What are their extents?</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ext</span><span class="op">(</span><span class="va">b10_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SpatExtent : 398865, 432705, 4825935, 4866405 (xmin, xmax, ymin, ymax)</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ext</span><span class="op">(</span><span class="va">casco_coastline</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SpatExtent : -70.244637867776, -69.843989726984, 43.5721328168498, 43.9322969014411 (xmin, xmax, ymin, ymax)</code></pre>
</div>
<p>Those are very different numbers due to their different CRS’s that we
looked at above. This means, we will have to REPROJECT one of the two
objects in order to crop it successfully, and then work in a common
CRS.</p>
<div id="which-data-source-should-i-reproject" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="which-data-source-should-i-reproject" class="callout-inner">
<h3 class="callout-title">Which data source should I reproject?<a class="anchor" aria-label="anchor" href="#which-data-source-should-i-reproject"></a>
</h3>
<div class="callout-content">
<p>Projection works on a pixel by pixel basis. That means that for every
pixel in your data, your computer will be doing work. As your data sets
increase in size, projection can be computationally very expensive. In
these cases, think about which layer will process faster. Often, it’s
faster to project vector data, as it contains a tiny fraction of the
points that are found in a raster data set.</p>
</div>
</div>
</div>
<p>While we can write a long CRS string, it’s easier to just take it
from an object or specify what’s called an EPSG code from <a href="https://epsg.org/home.html" class="external-link">epsg.org</a>. We can see those codes
using <code>crs()</code> from terra with
<code>describe = TRUE</code></p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">casco_coastline</span>, describe <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    name authority code area         extent
1 WGS 84      EPSG 4326 &lt;NA&gt; NA, NA, NA, NA</code></pre>
</div>
<p>From this we can see the EPSG code is <a href="https://epsg.io/4326" class="external-link">4326</a>.</p>
<p>For the SST data…</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">b10_casco_2022</span>, describe <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>                   name authority  code
1 WGS 84 / UTM zone 19N      EPSG 32619
                                                                                                                                                                                                                                                                                                                         area
1 Between 72°W and 66°W, northern hemisphere between equator and 84°N, onshore and offshore. Aruba. Bahamas. Brazil. Canada - New Brunswick (NB); Labrador; Nunavut; Nova Scotia (NS); Quebec. Colombia. Dominican Republic. Greenland. Netherlands Antilles. Puerto Rico. Turks and Caicos Islands. United States. Venezuela
           extent
1 -72, -66, 84, 0</code></pre>
</div>
<p>the EPSG code is <a href="https://epsg.io/32619" class="external-link">32619</a>.</p>
<p>Regardless, we can reproject the raster to the same projection as the
coastline.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2022_4326</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">b10_casco_2022</span>,</span>
<span>                               <span class="fu">crs</span><span class="op">(</span><span class="va">casco_coastline</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b10_casco_2022_4326</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster 
dimensions  : 1159, 1343, 1  (nrow, ncol, nlyr)
resolution  : 0.0003176554, 0.0003176554  (x, y)
extent      : -70.26025, -69.83364, 43.57953, 43.94769  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source(s)   : memory
name        : SST_F_20220909 
min value   :       63.06477 
max value   :       79.34391 </code></pre>
</div>
<p>Note the difference in information about the projection (and EPSG
code).</p>
<p>To transform <code>sf</code> vector data, we would have used the
function <code>st_transform()</code>.</p>
<div id="proj4-crs-resources" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="proj4-crs-resources" class="callout-inner">
<h3 class="callout-title">Proj4 &amp; CRS Resources<a class="anchor" aria-label="anchor" href="#proj4-crs-resources"></a>
</h3>
<div class="callout-content">
<ul>
<li><a href="https://proj4.org/" class="external-link">Official PROJ library
documentation</a></li>
<li><a href="https://proj.maptools.org/faq.html" class="external-link">More information on the
proj4 format.</a></li>
<li><a href="https://spatialreference.org" class="external-link">A fairly comprehensive list
of CRSs by format.</a></li>
<li>To view a list of datum conversion factors type:
<code>sf_proj_info(type = "datum")</code> into the R console. However,
the results would depend on the underlying version of the PROJ
library.</li>
</ul>
</div>
</div>
</div>
</section><section id="cropping-and-plotting"><h2 class="section-heading">Cropping and Plotting<a class="anchor" aria-label="anchor" href="#cropping-and-plotting"></a>
</h2>
<hr class="half-width">
<p>Now we can crop. We will first crop the SST raster to the coastline
in order to get rid of the NA area in the raster.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b10_casco_2022_4326_cropped</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span><span class="va">b10_casco_2022_4326</span>,</span>
<span>                                    <span class="va">casco_coastline</span><span class="op">)</span></span></code></pre>
</div>
<p>Then we will crop the coastline to the cropped raster in order to get
rid of that little bit of coast on the southern end.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">casco_coastline_cropped</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">casco_coastline</span>,</span>
<span>                                   <span class="va">b10_casco_2022_4326_cropped</span><span class="op">)</span></span></code></pre>
</div>
<p>Let’s plot it and see if all of the effort was worth it!</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2022_4326_cropped</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_coastline_cropped</span>, fill <span class="op">=</span> <span class="st">"tan"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"SST (F)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-plot_coast_sst-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section id="summary-when-crs-attacks"><h2 class="section-heading">Summary: When CRS Attacks<a class="anchor" aria-label="anchor" href="#summary-when-crs-attacks"></a>
</h2>
<hr class="half-width">
<p>The workflow outlined here, while in depth, is actually relatively
simple. When you have two or more spatial data sets that you want to
line up in terms of extent and projection.</p>
<ol start="0" style="list-style-type: decimal">
<li>Determine if they actually differ in projection. If not, skip to
2.</li>
<li>Reproject the smaller data source to the CRS of the larger one (if
size is a concern).</li>
<li>Crop back and forth to line up extents.</li>
<li>Plot!</li>
</ol>
<div id="challenge---show-us-the-temperature-of-seagrass-beds" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge---show-us-the-temperature-of-seagrass-beds" class="callout-inner">
<h3 class="callout-title">Challenge - Show us the temperature of
seagrass beds<a class="anchor" aria-label="anchor" href="#challenge---show-us-the-temperature-of-seagrass-beds"></a>
</h3>
<div class="callout-content">
<p>Let’s combine our SST and Seagrass data from 2022 to see if
seagrasses are in warm places around Mackworth. Let’s start by making a
Macworth Island AOI. We will do this by making a bounding box, and then
turning it into an sf object.</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mackworth_aoi</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="fu">c</span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="fl">70.24768051612979</span>, </span>
<span>                           xmax <span class="op">=</span> <span class="op">-</span><span class="fl">70.19432151530208</span>,</span>
<span>                           ymin <span class="op">=</span> <span class="fl">43.66353031177649</span>, </span>
<span>                           ymax <span class="op">=</span> <span class="fl">43.714022044471584</span><span class="op">)</span>,</span>
<span>                         crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_as_sfc</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<ol style="list-style-type: decimal">
<li><p>Reproject the AOI and seagrass data to the same projection as the
SST raster. Note, to get the CRS in a format <code>sf</code> recognizes,
use <code>st_crs()</code>. We can leave out the coast.</p></li>
<li><p>Crop everything to the Mackworth AOI. Note, <code>sf</code> uses
<code>st_crop()</code> while <code>terra</code> uses
<code>crop</code>.</p></li>
<li><p>Plot! Try leaving seagrass polygons with an <code>NA</code> fill
to see the temperature inside and outside of the beds. As land is NA
here, you can use the <code>na.value</code> argument to your
<code>scale_fill_*()</code> to make the land tan.</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Answers</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>Reprojection</li>
</ol>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco_2022_32619</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">seagrass_casco_2022</span>, </span>
<span>                                          <span class="fu">st_crs</span><span class="op">(</span><span class="va">b10_casco_2022</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mackworth_32619</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">mackworth_aoi</span>, </span>
<span>                              <span class="fu">st_crs</span><span class="op">(</span><span class="va">b10_casco_2022</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Cropping</li>
</ol>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco_2022_32619_mackworth</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">seagrass_casco_2022_32619</span>,</span>
<span>                                               <span class="va">mackworth_32619</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b10_casco_2022_mackworth</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span><span class="va">b10_casco_2022</span>,</span>
<span>                                 <span class="va">mackworth_32619</span><span class="op">)</span></span></code></pre>
</div>
<ol start="3" style="list-style-type: decimal">
<li>Plot!</li>
</ol>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">b10_casco_2022_mackworth</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022_32619_mackworth</span>, </span>
<span>          color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>          linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>          fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"tan"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-mack_plot_combined-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Looks like they are not in the warmest spots, but generally waters
that in this Landsat scene were a bit cooler.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Multi-layered plots can combine vector and raster data sets.</li>
<li>
<code>ggplot2</code> automatically converts all objects in a plot to
the same CRS.</li>
<li>Still be aware of the CRS and extent for each object.</li>
<li>
<code>project()</code> and <code>st_transform()</code> will
reproject raster and vector data.</li>
<li>
<code>crop()</code> and <code>st_crop()</code> will crop raster and
vector data.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-10-vector-csv-to-shapefile-in-r"><p>Content from <a href="10-vector-csv-to-shapefile-in-r.html">Convert from .csv to a Vector Layer</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/10-vector-csv-to-shapefile-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I import CSV files as vector layers in R?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Import .csv files containing x,y coordinate locations into R as a
data frame.</li>
<li>Convert a data frame to a spatial object.</li>
<li>Export a spatial object to a text file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
<p>You’ll need to load the following libraries</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>This episode will review how to import spatial points stored in
<code>.csv</code> (Comma Separated Value) format into R as an
<code>sf</code> spatial object. We will also plot it and save the data
as an ESRI <code>shapefile</code>.</p>
<section id="spatial-data-in-text-format"><h2 class="section-heading">Spatial Data in Text Format<a class="anchor" aria-label="anchor" href="#spatial-data-in-text-format"></a>
</h2>
<hr class="half-width">
<p>In the <a href="https://cobalt-casco.github.io/r-intro-geospatial/" class="external-link">Intro to R for
Geospatial</a> lessons, we worked with data from <a href="https://www.maine.gov/dmr/science/species-information/green-sea-urchins" class="external-link">Maine
DMR urchin surves</a> and Steneck/Rasher lab surveys of kelp forests up
and down the coast of Maine. This data contains <code>x, y</code>
(point) locations for study sites in the form of the variables
<code>longitude</code> and <code>latitude</code>.</p>
<p>We would like to:</p>
<ul>
<li>Create a map of these site locations.</li>
<li>Create a map showing the coastline as a reference</li>
<li>Export the data in an ESRI <code>shapefile</code> format to share
with our colleagues. This <code>shapefile</code> can be imported into
most GIS software.</li>
</ul>
<p>Spatial data are sometimes stored in a text file format
(<code>.txt</code> or <code>.csv</code>). If the text file has an
associated <code>x</code> and <code>y</code> location column, then we
can convert it into an <code>sf</code> spatial object. The
<code>sf</code> object allows us to store both the <code>x,y</code>
values that represent the coordinate location of each point and the
associated attribute data - or columns describing each feature in the
spatial object.</p>
</section><section id="import-.csv"><h2 class="section-heading">Import .csv<a class="anchor" aria-label="anchor" href="#import-.csv"></a>
</h2>
<hr class="half-width">
<p>To begin let’s import a <code>.csv</code> file that contains site
coordinate locations from these subtidal locations and look at the
structure of that new object:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dmr</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">read.csv</span><span class="op">(</span><span class="st">"data/maine_dmr/dmr_kelp_urchin.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">dmr</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	1478 obs. of  15 variables:
 $ year         : int  2001 2001 2001 2001 2001 2001 2001 2001 2001 2001 ...
 $ region       : chr  "York" "York" "York" "York" ...
 $ exposure.code: int  4 4 4 4 4 2 2 3 2 2 ...
 $ coastal.code : int  3 3 3 4 3 2 2 3 2 2 ...
 $ latitude     : num  43.1 43.3 43.4 43.5 43.5 ...
 $ longitude    : num  -70.7 -70.6 -70.4 -70.3 -70.3 ...
 $ depth        : int  5 5 5 5 5 5 5 5 5 5 ...
 $ crust        : num  60 75.5 73.5 63.5 72.5 6.1 31.5 31.5 40.5 53 ...
 $ understory   : num  100 100 80 82 69 38.5 74 96.5 60 59.5 ...
 $ kelp         : num  1.9 0 18.5 0.6 63.5 92.5 59 7.7 52.5 29.2 ...
 $ urchin       : num  0 0 0 0 0 0 0 0 0 0 ...
 $ month        : int  6 6 6 6 6 6 6 6 6 6 ...
 $ day          : int  13 13 14 14 14 15 15 15 8 8 ...
 $ survey       : chr  "dmr" "dmr" "dmr" "dmr" ...
 $ site         : int  42 47 56 61 62 66 71 70 23 22 ...</code></pre>
</div>
<p>We now have a data frame that contains 1478 locations (rows) and 15
variables (attributes). Note that all of our character data was imported
into R as character (text) data. Next, let’s explore the dataframe to
determine whether it contains columns with coordinate values. If we are
lucky, our <code>.csv</code> will contain columns labeled:</p>
<ul>
<li>“X” and “Y” OR</li>
<li>Latitude and Longitude OR</li>
<li>easting and northing (UTM coordinates)</li>
</ul>
<p>Let’s check out the column names of our dataframe.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">dmr</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "year"          "region"        "exposure.code" "coastal.code" 
 [5] "latitude"      "longitude"     "depth"         "crust"        
 [9] "understory"    "kelp"          "urchin"        "month"        
[13] "day"           "survey"        "site"         </code></pre>
</div>
</section><section id="identify-xy-location-columns"><h2 class="section-heading">Identify X,Y Location Columns<a class="anchor" aria-label="anchor" href="#identify-xy-location-columns"></a>
</h2>
<hr class="half-width">
<p>Our column names include several fields that might contain spatial
information. The <code>dmr$longitude</code> and
<code>dmr$latitude</code> columns contain coordinate values. We can
confirm this by looking at the first six rows of our data.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">dmr</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] -70.66749 -70.55645 -70.38046 -70.32038 -70.30401 -70.10721</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">dmr</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 43.06709 43.28014 43.40849 43.50783 43.52791 43.72766</code></pre>
</div>
<p>We have coordinate values in our data frame. In order to convert our
data frame to an <code>sf</code> object, we also need to know the CRS
associated with those coordinate values.</p>
<p>There are several ways to figure out the CRS of spatial data in text
format.</p>
<ol style="list-style-type: decimal">
<li>We can check the file metadata in hopes that the CRS was recorded in
the data.</li>
<li>We can explore the file itself to see if CRS information is embedded
in the file header or somewhere in the data columns.</li>
</ol>
<p>In our case, as we have decimal degrees, this is likely a standard
WGS 84 defined under EPSG code 4326. However, it always behoves you to
check!</p>
<p>If we had had columns like <code>easting</code> and
<code>northing</code> columns, then we are likely dealing with UTM or
otherwise. Check if there is a <code>geodeticDatum</code> and a
<code>utmZone</code> column. These appear to contain CRS information
(<code>datum</code> and <code>projection</code>). Or, again, check the
metadata for the data set.</p>
<p>In <a href="09-vector-when-data-dont-line-up-crs/">When Vector Data
Don’t Line Up - Handling Spatial Projection &amp; CRS in R</a> we
learned about the components of a <code>proj4</code> string and
<code>EPSG</code>. We have everything we need to assign a CRS to our
data frame. If we wanted, we could use another loaded shapefile to
extract a CRS and use it here. That is not needed, however, as
<code>sf</code> lets us use EPSG codes.</p>
</section><section id="csv-to-sf-object"><h2 class="section-heading">.csv to sf object<a class="anchor" aria-label="anchor" href="#csv-to-sf-object"></a>
</h2>
<hr class="half-width">
<p>Let’s convert our dataframe into an <code>sf</code> object. To do
this, we need to specify:</p>
<ol style="list-style-type: decimal">
<li>The columns containing X (<code>longitude</code>) and Y
(<code>latitude</code>) coordinate values</li>
<li>The CRS. Either as an object or an EPSG code.</li>
</ol>
<p>We will use the <code>st_as_sf()</code> function to perform the
conversion.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dmr_sf</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">dmr</span>,</span>
<span>                   coords <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>,</span>
<span>                   crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span></code></pre>
</div>
<p>We should double check the CRS to make sure it is correct.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">dmr_sf</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: EPSG:4326 
  wkt:
GEOGCRS["WGS 84",
    ENSEMBLE["World Geodetic System 1984 ensemble",
        MEMBER["World Geodetic System 1984 (Transit)"],
        MEMBER["World Geodetic System 1984 (G730)"],
        MEMBER["World Geodetic System 1984 (G873)"],
        MEMBER["World Geodetic System 1984 (G1150)"],
        MEMBER["World Geodetic System 1984 (G1674)"],
        MEMBER["World Geodetic System 1984 (G1762)"],
        MEMBER["World Geodetic System 1984 (G2139)"],
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]],
        ENSEMBLEACCURACY[2.0]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["geodetic latitude (Lat)",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["geodetic longitude (Lon)",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    USAGE[
        SCOPE["Horizontal component of 3D system."],
        AREA["World."],
        BBOX[-90,-180,90,180]],
    ID["EPSG",4326]]</code></pre>
</div>
</section><section id="plot-spatial-object"><h2 class="section-heading">Plot Spatial Object<a class="anchor" aria-label="anchor" href="#plot-spatial-object"></a>
</h2>
<hr class="half-width">
<p>We now have a spatial R object, we can plot our newly created spatial
object.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dmr_sf</span>,</span>
<span>          mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Map of Site Locations"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/10-vector-csv-to-shapefile-in-r-rendered-plot-data-points-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Looks good! If we really want to check, we can either load up our
state of Maine shapefile or plot it against a tiles with
<code>leaflet</code>.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">colorFactor</span><span class="op">(</span><span class="st">"Set1"</span>,</span>
<span>                   domain <span class="op">=</span> <span class="va">dmr_sf</span><span class="op">$</span><span class="va">region</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addCircles</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dmr_sf</span>,</span>
<span>             color <span class="op">=</span> <span class="op">~</span><span class="fu">pal</span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div id="challenge---import-plot-additional-points" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge---import-plot-additional-points" class="callout-inner">
<h3 class="callout-title">Challenge - Import &amp; Plot Additional
Points<a class="anchor" aria-label="anchor" href="#challenge---import-plot-additional-points"></a>
</h3>
<div class="callout-content">
<p>Load just Casco Bay and plot it along with the Maine coastal
shapefile. Use the Casco data to crop the Maine shapefile and plot them
together.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Answers</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load Casco</span></span>
<span><span class="va">casco_dmr</span> <span class="op">&lt;-</span> <span class="fu">read.csv</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_dmr/casco_kelp_urchin.csv"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Turn it into an sf object</span></span>
<span><span class="va">casco_dmr_sf</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">casco_dmr</span>,</span>
<span>                         coords <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>,</span>
<span>                         crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load Maine</span></span>
<span><span class="va">maine</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/Maine_State_Boundary_Polygon_Feature/Maine_State_Boundary_Polygon_Feature.shp"</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Crop to Casco</span></span>
<span><span class="va">casco</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">maine</span> <span class="op">|&gt;</span> <span class="fu">st_make_valid</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                 <span class="va">casco_dmr_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot!</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_dmr_sf</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/10-vector-csv-to-shapefile-in-r-rendered-unnamed-chunk-3-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<p>Sometimes, we want to crop to a larger area than just the data set.
For that, we can create a box from the extent of the new vector object
using <code>st_bbox()</code>. This, though, is really just a vector, so
we need to turn it into a polygon using <code>st_sfc()</code> (sfc
objects are just a raw shape, while sf contains data).</p>
<p>To make this box bigger, we can use <code>st_buffer()</code> which
will create a buffer area using a distance specified in meters. So,
<code>1e4</code> would be 10km.</p>
<p>This technique can be a nice way to put a new vector file in context,
as follows.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Make a bounding box of the Casco Bay area from the data</span></span>
<span><span class="va">casco_bbox</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">casco_dmr_sf</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_as_sfc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Enlarge it by 10 km</span></span>
<span><span class="va">casco_bbox_big</span> <span class="op">&lt;-</span> <span class="fu">st_buffer</span><span class="op">(</span><span class="va">casco_bbox</span>, </span>
<span>                            dist <span class="op">=</span> <span class="fl">1e4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Crop to the new area</span></span>
<span><span class="va">casco</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">maine</span> <span class="op">|&gt;</span> <span class="fu">st_make_valid</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                 <span class="va">casco_bbox_big</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot!</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco</span>, fill <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_dmr_sf</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/10-vector-csv-to-shapefile-in-r-rendered-unnamed-chunk-4-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</section><section id="export-to-an-esri-shapefile"><h2 class="section-heading">Export to an ESRI <code>shapefile</code><a class="anchor" aria-label="anchor" href="#export-to-an-esri-shapefile"></a>
</h2>
<hr class="half-width">
<p>We can write an R spatial object to an ESRI <code>shapefile</code>
using the <code>st_write</code> function in <code>sf</code>. To do this
we need the following arguments:</p>
<ul>
<li>the name of the spatial object (<code>dmr_sf</code>)</li>
<li>the directory where we want to save our ESRI <code>shapefile</code>
(to use <code>current = getwd()</code> or you can specify a different
path). You can also use <code>dir.create()</code> no make a new
directory.</li>
<li>the name of the new ESRI <code>shapefile</code>
(<code>dmr_kelp_urchins</code>)</li>
<li>the driver which specifies the file format (ESRI Shapefile)</li>
</ul>
<p>We can now export the spatial object as an ESRI
<code>shapefile</code>. Note - this will make a few files.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dir.create</span><span class="op">(</span><span class="st">"data/dmr_kelp_urchins"</span><span class="op">)</span></span>
<span><span class="fu">st_write</span><span class="op">(</span><span class="va">dmr_sf</span>,</span>
<span>         <span class="st">"data/dmr_kelp_urchins/dmr_kelp_urchins.shp"</span>, driver <span class="op">=</span> <span class="st">"ESRI Shapefile"</span><span class="op">)</span></span></code></pre>
</div>
<div id="keypoints2" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints2"></a>
</h3>
<div class="callout-content">
<ul>
<li>Know the projection (if any) of your point data prior to converting
to a spatial object.</li>
<li>Convert a data frame to an <code>sf</code> object using the
<code>st_as_sf()</code> function.</li>
<li>Export an <code>sf</code> object as text using the
<code>st_write()</code> function.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-11-vector-raster-integration"><p>Content from <a href="11-vector-raster-integration.html">Extracting Data from Rasters using Vectors</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/11-vector-raster-integration.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I crop raster objects to vector objects, and extract the
summary of raster pixels?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Crop a raster to the extent of a vector layer.</li>
<li>Extract values from a raster that correspond to a vector file
overlay.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<section id="load-libraries"><h2 class="section-heading">Load Libraries<a class="anchor" aria-label="anchor" href="#load-libraries"></a>
</h2>
<hr class="half-width">
<p>This episode explains how to crop a raster using the extent of a
vector layer. We will also cover how to extract values from a raster
that occur within a set of polygons, or in a buffer (surrounding) region
around a set of points.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyterra</span><span class="op">)</span></span></code></pre>
</div>
</section><section id="crop-a-raster-to-vector-extent"><h2 class="section-heading">Crop a Raster to Vector Extent<a class="anchor" aria-label="anchor" href="#crop-a-raster-to-vector-extent"></a>
</h2>
<hr class="half-width">
<p>We often work with spatial layers that have different spatial
extents. The spatial extent of a vector layer or R spatial object
represents the geographic “edge” or location that is the furthest north,
south east and west. Thus it represents the overall geographic coverage
of the spatial object.</p>
<p><img src="fig/dc-spatial-vector/spatial_extent.png" alt="Extent illustration" class="figure"> Image Source: National Ecological
Observatory Network (NEON)</p>
<p>The graphic below illustrates the extent of several of the spatial
layers that we have worked with in this workshop and one new one:</p>
<ul>
<li>Area of interest (AOI) – blue</li>
<li>Seagrass Beds – purple</li>
<li>Areas surveyed for kelp and urchins (marked with white dots)–
black</li>
<li>Water turbidity in GeoTIFF format – green</li>
</ul>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Casco AOI</span></span>
<span><span class="va">aoi_boundary_casco</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/casco_aoi/casco_bay_aoi.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># seagrass in 2022</span></span>
<span><span class="va">seagrass_casco_2022</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_seagrass/MaineDEP_Casco_Bay_Seagrass_2022/MaineDEP_Casco_Bay_Seagrass_2022.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># subtidal samples</span></span>
<span><span class="va">dmr_casco</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">read.csv</span><span class="op">(</span><span class="st">"data/maine_dmr/casco_kelp_urchin.csv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span>coords <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># turbidity from modis</span></span>
<span><span class="va">turbidity_modis</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="st">"data/modis/GIOVANNI-g4.timeAvgMap.MODISA_L3m_KD_Mo_4km_R2022_0_Kd_490.20230701-20230930.71W_42N_66W_45N.tif"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-compare-data-extents-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Frequent use cases of cropping a raster file include reducing file
size and creating maps. Sometimes we have a raster file that is much
larger than our study area or area of interest. It is often more
efficient to crop the raster to the extent of our study area to reduce
file sizes as we process our data. Cropping a raster can also be useful
when creating pretty maps so that the raster layer matches the extent of
the desired vector layers.</p>
</section><section id="crop-a-raster-using-vector-extent"><h2 class="section-heading">Crop a Raster Using Vector Extent<a class="anchor" aria-label="anchor" href="#crop-a-raster-using-vector-extent"></a>
</h2>
<hr class="half-width">
<p>We can use the <code>crop()</code> function to crop a raster to the
extent of another spatial object. To do this, we need to specify the
raster to be cropped and the spatial object that will be used to crop
the raster. R will use the <code>extent</code> of the spatial object as
the cropping boundary.</p>
<p>To illustrate this, we will crop the MODIS turbidity data to only
include the area of interest (AOI). Let’s start by plotting the full
extent of the CHM data and overlay where the AOI falls within it. The
boundaries of the AOI will be colored blue, and we use
<code>fill = NA</code> to make the area transparent.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">turbidity_modis</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Turbidity Score"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_casco</span>, color <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-crop-by-vector-extent-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Now that we have visualized the area of the turbidity data we want to
subset, we can perform the cropping operation. We are going to
<code>crop()</code> function from the raster package to create a new
object with only the portion of the MODIS data that falls within the
boundaries of the AOI.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">turbidity_casco</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span>x <span class="op">=</span> <span class="va">turbidity_modis</span>, y <span class="op">=</span> <span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can plot the cropped MODIS data, along with a boundary box
showing the full MODIS extent. However, remember, since this is raster
data, we need to convert to a data frame in order to plot using
<code>ggplot</code>. To get the boundary box from MODIS, the
<code>st_bbox()</code> will extract the 4 corners of the rectangle that
encompass all the features contained in this object. The
<code>st_as_sfc()</code> converts these 4 coordinates into a polygon
that we can plot:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_as_sfc</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">turbidity_modis</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"green"</span>,</span>
<span>          color <span class="op">=</span> <span class="st">"green"</span>, alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">turbidity_casco</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Turbidity Score"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-show-cropped-area-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The plot above shows that the full MODS extent (plotted in green) is
much larger than the resulting cropped raster. Our new cropped MODS now
has the same extent as the <code>aoi_boundary_casco</code> object that
was used as a crop extent (blue border below).</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">turbidity_casco</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_casco</span>, color <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Turbidity Score"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-view-crop-extent-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We can look at the extent of all of our other objects for this field
site.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">turbidity_modis</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-71.29166  42.66666 -66.62500  45.00000 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">turbidity_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-70.25000  43.58333 -69.83333  43.95833 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    xmin     ymin     xmax     ymax 
-70.2528  43.5834 -69.8387  43.9439 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-70.24464  43.57213 -69.84399  43.93221 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">dmr_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax 
-70.21650  43.55470 -69.83280  43.79721 </code></pre>
</div>
<p>Our <code>dmr_casco</code> location extent is not the largest It
would be nice to see our vegetation plot locations plotted on top of the
turbidity information.</p>
<div id="challenge-crop-to-vector-points-extent" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-crop-to-vector-points-extent" class="callout-inner">
<h3 class="callout-title">Challenge: Crop to Vector Points Extent<a class="anchor" aria-label="anchor" href="#challenge-crop-to-vector-points-extent"></a>
</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>Crop the MODIS turbidity data to the extent of the study plot
locations.</li>
<li>Plot the DMR site location points on top of the turbidity data.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Answers</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">turbidity_dmr_sites</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span>x <span class="op">=</span> <span class="va">turbidity_modis</span>, y <span class="op">=</span> <span class="va">dmr_casco</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">turbidity_dmr_sites</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dmr_casco</span><span class="op">)</span> </span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-challenge-code-crop-raster-points-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<p>In the plot above, created in the challenge, all the site locations
(black dots) appear on the turbidity raster layer except for a few. some
are situated on the blank space to the left of the map. Why?</p>
<p>The raster data is in a resolution such that many of the coastal
pixels are eliminated as not valid data. Check the resolution of the
raster. It’s 0.417 degrees. 1 degree is ~ 111,111 meters. So, 1 pixel
here is ~ 4,600 meters, or 4.6km. We are going to lose a lot of things
close to the coast.</p>
<p>Thinking about data source resolution is key in thinking about
rasters when you want to get data close to the coast versus more
offshore.</p>
</section><section id="extract-raster-pixels-values-using-vector-polygons"><h2 class="section-heading">Extract Raster Pixels Values Using Vector Polygons<a class="anchor" aria-label="anchor" href="#extract-raster-pixels-values-using-vector-polygons"></a>
</h2>
<hr class="half-width">
<p>Often we want to extract values from a raster layer for particular
locations - for example, plot locations that we are sampling on the
ground. We can extract all pixel values within 20m of our x,y point of
interest. These can then be summarized into some value of interest
(e.g. mean, maximum, total).</p>
<p><img src="fig//BufferSquare.png" alt="Image shows raster information extraction using 20m polygon boundary." class="figure">
Image Source: National Ecological Observatory Network (NEON)</p>
<p>To do this in R, we use the <code>extract()</code> function. The
<code>extract()</code> function requires:</p>
<ul>
<li>The raster that we wish to extract values from,</li>
<li>The vector layer containing the polygons that we wish to use as a
boundary or boundaries,</li>
<li>we can tell it to store the output values in a data frame using
<code>raw = FALSE</code> (this is optional).</li>
</ul>
<p>We will begin by extracting all canopy height pixel values located
within our <code>aoi_boundary_casco</code> polygon which surrounds the
tower located at the NEON Harvard Forest field site.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">turbidity_casco</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"turbidity"</span></span>
<span></span>
<span><span class="va">turbidity_df</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>x <span class="op">=</span> <span class="va">turbidity_casco</span>, </span>
<span>                     y <span class="op">=</span> <span class="va">aoi_boundary_casco</span>, </span>
<span>                     raw <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">turbidity_df</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	90 obs. of  2 variables:
 $ ID       : num  1 1 1 1 1 1 1 1 1 1 ...
 $ turbidity: num  NA NA NA NA NA NA NA NA NA NA ...</code></pre>
</div>
<p>When we use the <code>extract()</code> function, R extracts the value
for each pixel located within the boundary of the polygon being used to
perform the extraction - in this case the
<code>aoi_boundary_casco</code> object (a single polygon). Here, the
function extracted values from 90 pixels.</p>
<p>We can create a histogram of turbidity values within the boundary to
better understand the structure or height distribution of turbidity at
our site. We will use the column <code>turbidity</code> from our data
frame as our x values.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">turbidity_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">turbidity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Histogram of turbidity values"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"turbidity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Frequency of Pixels"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: Removed 52 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-view-extract-histogram-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We can also use the <code>summary()</code> function to view
descriptive statistics including min, max, and mean height values. These
values help us better understand vegetation at our field site.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">summary</span><span class="op">(</span><span class="va">turbidity_df</span><span class="op">$</span><span class="va">turbidity</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
 0.7771  1.6590  2.8625  2.8668  3.6165  6.0000      52 </code></pre>
</div>
</section><section id="summarize-extracted-raster-values"><h2 class="section-heading">Summarize Extracted Raster Values<a class="anchor" aria-label="anchor" href="#summarize-extracted-raster-values"></a>
</h2>
<hr class="half-width">
<p>We often want to extract summary values from a raster. We can tell R
the type of summary statistic we are interested in using the
<code>fun =</code> argument. Let’s extract a mean height value for our
AOI.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_turbidity_aoi</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>x <span class="op">=</span> <span class="va">turbidity_casco</span>, </span>
<span>                                 y <span class="op">=</span> <span class="va">aoi_boundary_casco</span>, </span>
<span>                                fun <span class="op">=</span> <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mean_turbidity_aoi</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  ID turbidity
1  1  2.866811</code></pre>
</div>
<p>It appears that the mean height value, extracted from our LiDAR data
derived canopy height model is 22.43 meters.</p>
</section><section id="extract-data-using-xy-locations"><h2 class="section-heading">Extract Data using x,y Locations<a class="anchor" aria-label="anchor" href="#extract-data-using-xy-locations"></a>
</h2>
<hr class="half-width">
<p>We can also extract pixel values from a raster by defining a buffer
or area surrounding individual point locations using the
<code>st_buffer()</code> function. To do this we define the summary
argument (<code>fun = mean</code>) and the buffer distance
(<code>dist = 20</code>) which represents the radius of a circular
region around each point. By default, the units of the buffer are the
same units as the data’s CRS. All pixels that are touched by the buffer
region are included in the extract.</p>
<p><img src="fig/BufferCircular.png" alt="Image shows raster information extraction using 20m buffer region." class="figure">
Image Source: National Ecological Observatory Network (NEON)</p>
<p>Let’s put this into practice by figuring out the mean tree height in
the 20m around the tower location (<code>point_HARV</code>).</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_turbidity_sites</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>x <span class="op">=</span> <span class="va">turbidity_casco</span>,</span>
<span>                                  y <span class="op">=</span> <span class="fu">st_buffer</span><span class="op">(</span><span class="va">dmr_casco</span>, dist <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                                  fun <span class="op">=</span> <span class="va">mean</span>,</span>
<span>                                raw <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">hist</span><span class="op">(</span><span class="va">mean_turbidity_sites</span><span class="op">$</span><span class="va">turbidity</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-extract-point-to-buffer-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-extract-temperature-values-for-seagrass-beds" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-extract-temperature-values-for-seagrass-beds" class="callout-inner">
<h3 class="callout-title">Challenge: Extract Temperature Values For
Seagrass Beds<a class="anchor" aria-label="anchor" href="#challenge-extract-temperature-values-for-seagrass-beds"></a>
</h3>
<div class="callout-content">
<p>You can also extract data from polygons. Let’s look at temperature in
seagrass beds in 2022.</p>
<ol style="list-style-type: decimal">
<li><p>Load up
“data/landsat_casco/b10_cropped/LC08_L2SP_011030_20220909_20220914_02_T1_ST_B10.TIF”.
Reproject it and crop it to the extent of
<code>seagrass_casco_2022</code> - smaller rasters = faster
extraction.</p></li>
<li><p>Extract the average SST in each bed. <code>cbind()</code> it back
to <code>seagrass_casco_2022</code></p></li>
<li><p>Plot SST by Hectares of seagrass bed.</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Answers</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>We can do this as a processing chain!</li>
</ol>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sst</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span></span>
<span>  <span class="st">"data/landsat_casco/b10_cropped/LC08_L2SP_011030_20220909_20220914_02_T1_ST_B10.TIF"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">project</span><span class="op">(</span><span class="fu">crs</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">crop</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span></span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>We can extract now. Note, some beds will throw an NaN, as</li>
</ol>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_beds</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span><span class="va">sst</span>,</span>
<span>                     <span class="va">seagrass_casco_2022</span>,</span>
<span>                     fun <span class="op">=</span> <span class="va">mean</span>,</span>
<span>                     na.rm <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     raw <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_casco_2022</span> <span class="op">&lt;-</span> <span class="fu">cbind</span><span class="op">(</span><span class="va">seagrass_casco_2022</span>, <span class="va">temp_beds</span><span class="op">)</span></span></code></pre>
</div>
<ol start="3" style="list-style-type: decimal">
<li>It’s just a <code>geom_point()</code>
</li>
</ol>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">SST_F_20220909</span>, y <span class="op">=</span> <span class="va">Hectares</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: Removed 314 rows containing missing values (`geom_point()`).</code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-unnamed-chunk-4-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Use the <code>crop()</code> function to crop a raster object.</li>
<li>Use the <code>extract()</code> function to extract pixels from a
raster object that fall within a particular extent boundary.</li>
<li>Use the <code>ext()</code> function to define an extent.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-05-raster-multi-band-in-r"><p>Content from <a href="05-raster-multi-band-in-r.html">Work with Multi-Band Rasters</a></p>
<hr>
<p>Last updated on 2024-01-09 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/05-raster-multi-band-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I visualize individual and multiple bands in a raster
object?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Identify a single vs. a multi-band raster file.</li>
<li>Import multi-band rasters into R using the <code>terra</code>
package.</li>
<li>Plot multi-band color image rasters in R using the
<code>ggplot</code> package.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>First, some libraries you might not have loaded at the moment.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyterra</span><span class="op">)</span></span></code></pre>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>We introduced multi-band raster data in <a href="https://cobalt-casco.github.io/organization-geospatial/01-intro-raster-data" class="external-link">an
earlier lesson</a>. This episode explores how to import and plot a
multi-band raster in R.</p>
<section id="getting-started-with-multi-band-data-in-r"><h2 class="section-heading">Getting Started with Multi-Band Data in R<a class="anchor" aria-label="anchor" href="#getting-started-with-multi-band-data-in-r"></a>
</h2>
<hr class="half-width">
<p>In this episode, the multi-band data that we are working with is
imagery collected using the <a href="https://www.usgs.gov/landsat-missions/landsat-8" class="external-link">Landsat 8
Satellite</a> satellite on row 12 path 30 of it’s traverse around the
planet. Landsat is a series of multispectral satellites with a 30m pixel
resolution. This means that each image has multiple wavelengths of light
observed - not just Red, Green, and Blue (RGB). Here are the bands of
the Landsat 8 OLI:</p>
<ul>
<li>Band 1 Coastal Aerosol (0.43 - 0.45 µm) 30 m</li>
<li>Band 2 Blue (0.450 - 0.51 µm) 30 m</li>
<li>Band 3 Green (0.53 - 0.59 µm) 30 m</li>
<li>Band 4 Red (0.64 - 0.67 µm) 30 m</li>
<li>Band 5 Near-Infrared (0.85 - 0.88 µm) 30 m</li>
<li>Band 6 SWIR 1(1.57 - 1.65 µm) 30 m</li>
<li>Band 7 SWIR 2 (2.11 - 2.29 µm) 30 m</li>
<li>Band 8 Panchromatic (PAN) (0.50 - 0.68 µm) 15 m</li>
<li>Band 9 Cirrus (1.36 - 1.38 µm) 30 m</li>
</ul>
<p>So, 4, 3, and 2 are RGB. By using the <code>rast()</code> function we
can read one raster bands (i.e. the first one) or many.</p>
<p>Let’s start by looking at the red band.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_band4_1230</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B4.TIF"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">landsat_band4_1230</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greys"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-read-single-band-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge" class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge"></a>
</h3>
<div class="callout-content">
<p>View the attributes of this band. What are its dimensions, CRS,
resolution, min and max values, and band number?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_band4_1230</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster 
dimensions  : 7991, 7891, 1  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 232485, 469215, 4662585, 4902315  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 19N (EPSG:32619) 
source      : LC08_L2SP_012030_20230903_20230912_02_T1_SR_B4.TIF 
name        : LC08_L2SP_012030_20230903_20230912_02_T1_SR_B4 </code></pre>
</div>
<p>Notice that when we look at the attributes of this band, we see:
<code>dimensions  :  7991, 7891, 1  (nrow, ncol, nlyr)</code></p>
<p>This is R telling us that we read only one band.</p>
</div>
</div>
</div>
</div>
</section><section id="raster-stacks-in-r"><h2 class="section-heading">Raster Stacks in R<a class="anchor" aria-label="anchor" href="#raster-stacks-in-r"></a>
</h2>
<hr class="half-width">
<p>Next, we will work with mutiple bands as an R raster object. We will
then plot a 3-band composite, or full color, image, and what is called a
‘fasle-color’ image.</p>
<p>To bring in all bands of a multi-band raster, we use
the<code>rast()</code> function.</p>
<p>For multi-layer views, we need to look at all of the files we get
with a typical sensor image. They are often listed as different files
(although they can come in one big file.) Let’s see what a typical
Landsat image has.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">list.files</span><span class="op">(</span><span class="st">"data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "LC08_L2SP_012030_20230903_20230912_02_T1_ANG.txt"          
 [2] "LC08_L2SP_012030_20230903_20230912_02_T1_MTL.txt"          
 [3] "LC08_L2SP_012030_20230903_20230912_02_T1_MTL.xml"          
 [4] "LC08_L2SP_012030_20230903_20230912_02_T1_QA_PIXEL.TIF"     
 [5] "LC08_L2SP_012030_20230903_20230912_02_T1_QA_RADSAT.TIF"    
 [6] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B1.TIF"        
 [7] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B2.TIF"        
 [8] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B3.TIF"        
 [9] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B4.TIF"        
[10] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B5.TIF"        
[11] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B6.TIF"        
[12] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B7.TIF"        
[13] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_QA_AEROSOL.TIF"</code></pre>
</div>
<p>That’s a lot of files! To load them in with <code>rast()</code> in a
single object, thought, we will want only those that are TIF files, and
we will need the full path to each one. Fortunately,
<code>list.files()</code> makes that easy for us.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_files</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">list.files</span><span class="op">(</span><span class="st">"data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1"</span>,</span>
<span>             full.names <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>             pattern <span class="op">=</span> <span class="st">"TIF"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">landsat_files</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_QA_PIXEL.TIF"     
 [2] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_QA_RADSAT.TIF"    
 [3] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B1.TIF"        
 [4] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B2.TIF"        
 [5] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B3.TIF"        
 [6] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B4.TIF"        
 [7] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B5.TIF"        
 [8] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B6.TIF"        
 [9] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_B7.TIF"        
[10] "data/landsat_casco/LC08_L2SP_012030_20230903_20230912_02_T1/LC08_L2SP_012030_20230903_20230912_02_T1_SR_QA_AEROSOL.TIF"</code></pre>
</div>
<p>Great! We can now load those in smoothly with
<code>rast()</code>.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load all bands</span></span>
<span><span class="va">landsat_all_1230</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">landsat_files</span><span class="op">)</span></span>
<span></span>
<span><span class="va">landsat_all_1230</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster 
dimensions  : 7991, 7891, 10  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 232485, 469215, 4662585, 4902315  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 19N (EPSG:32619) 
sources     : LC08_L2SP_012030_20230903_20230912_02_T1_QA_PIXEL.TIF  
              LC08_L2SP_012030_20230903_20230912_02_T1_QA_RADSAT.TIF  
              LC08_L2SP_012030_20230903_20230912_02_T1_SR_B1.TIF  
              ... and 7 more source(s)
names       : LC08_~PIXEL, LC08_~ADSAT, LC08_~SR_B1, LC08_~SR_B2, LC08_~SR_B3, LC08_~SR_B4, ... </code></pre>
</div>
<p>Now we have a very different set of dimensions and names.</p>
<p><code>dimensions  : 7991, 7891, 10  (nrow, ncol, nlyr)</code></p>
<p>10 bands! To see what is loaded, we can just use
<code>names()</code></p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">landsat_all_1230</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "LC08_L2SP_012030_20230903_20230912_02_T1_QA_PIXEL"     
 [2] "LC08_L2SP_012030_20230903_20230912_02_T1_QA_RADSAT"    
 [3] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B1"        
 [4] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B2"        
 [5] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B3"        
 [6] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B4"        
 [7] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B5"        
 [8] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B6"        
 [9] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_B7"        
[10] "LC08_L2SP_012030_20230903_20230912_02_T1_SR_QA_AEROSOL"</code></pre>
</div>
<div id="data-tip" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip<a class="anchor" aria-label="anchor" href="#data-tip"></a>
</h3>
<div class="callout-content">
<p>The number of bands associated with a raster’s file can also be
determined using the <code>describe()</code> function: syntax is
<code>describe(sources(landsat_all_1230))</code>.</p>
</div>
</div>
</div>
<p>We just want red, green, blue, and near-infrared for now - bands 2
through 5. Note how that corresponds to layers 4 through 7. So we can
subset down.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_colors_1230</span> <span class="op">&lt;-</span> <span class="fu">subset</span><span class="op">(</span><span class="va">landsat_all_1230</span>,</span>
<span>                              subset <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span></span></code></pre>
</div>
<p>Let’s preview the attributes of our stack object:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_colors_1230</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster 
dimensions  : 7991, 7891, 4  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 232485, 469215, 4662585, 4902315  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 19N (EPSG:32619) 
sources     : LC08_L2SP_012030_20230903_20230912_02_T1_SR_B2.TIF  
              LC08_L2SP_012030_20230903_20230912_02_T1_SR_B3.TIF  
              LC08_L2SP_012030_20230903_20230912_02_T1_SR_B4.TIF  
              LC08_L2SP_012030_20230903_20230912_02_T1_SR_B5.TIF  
names       : LC08_L2~1_SR_B2, LC08_L2~1_SR_B3, LC08_L2~1_SR_B4, LC08_L2~1_SR_B5 </code></pre>
</div>
<p>We can view the attributes of each band in the stack in a single
output. For example, if we had hundreds of bands, we could specify which
band we’d like to view attributes for using an index value:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_colors_1230</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster 
dimensions  : 7991, 7891, 1  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 232485, 469215, 4662585, 4902315  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 19N (EPSG:32619) 
source      : LC08_L2SP_012030_20230903_20230912_02_T1_SR_B3.TIF 
name        : LC08_L2SP_012030_20230903_20230912_02_T1_SR_B3 </code></pre>
</div>
<p>We can also use the <code>ggplot</code> functions to plota histogram
of the first (blue) band:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">landsat_colors_1230</span>, </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">LC08_L2SP_012030_20230903_20230912_02_T1_SR_B3</span><span class="op">)</span>,</span>
<span>                 bins <span class="op">=</span> <span class="fl">1e4</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-rgb-hist-band1-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>This tells us that, for example, we might want to cutoff high
quantiles when we start to blend colors for an RGB plot.</p>
<p>We can also plot <em>all</em> of the bands with either
<code>plot()</code> or <code>ggplot()</code> adding a
<code>facet_wrap(facets = vars(lyr))</code> call to facet by layer.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#plot(landsat_colors_1230)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">landsat_colors_1230</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span>facets <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">lyr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greys"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-plot-lyrs-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-making-sense-of-single-band-images" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-making-sense-of-single-band-images" class="callout-inner">
<h3 class="callout-title">Challenge: Making Sense of Single Band
Images<a class="anchor" aria-label="anchor" href="#challenge-making-sense-of-single-band-images"></a>
</h3>
<div class="callout-content">
<p>Compare the plots of band 4 (red) and band 5 (near infrared). Is the
land darker or lighter in band 4 (the red band) compared to band 5 (near
infrared)?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">landsat_colors_1230</span><span class="op">[[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span>facets <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">lyr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_b</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<p>We’d expect a <em>brighter</em> value for the land in band 5 (NIR)
than in band 4 (red) because healthy vegetation reflects MORE NIR light
than red light.</p>
</div>
</div>
</div>
</div>
</section><section id="create-a-three-band-image"><h2 class="section-heading">Create A Three Band Image<a class="anchor" aria-label="anchor" href="#create-a-three-band-image"></a>
</h2>
<hr class="half-width">
<p>To render a final three band, colored image in R, we use the
<code>plotRGB()</code> or <code>geom_spatraster_rgb()</code>
function.</p>
<p>This function allows us to:</p>
<ol style="list-style-type: decimal">
<li><p>Identify what bands we want to render in the red, green and blue
regions. The <code>plotRGB()</code> function defaults to a 1=red,
2=green, and 3=blue band order. However, you can define what bands you’d
like to plot manually. Manual definition of bands is useful if you have,
for example a near-infrared band and want to create a color infrared
image.</p></li>
<li><p>Adjust the <code>stretch</code> of the image to increase or
decrease contrast.</p></li>
</ol>
<p>Let’s plot our 3-band image. Note that we can use the
<code>plotRGB()</code> function directly with our RasterStack object (we
don’t need a dataframe as this function isn’t part of the
<code>ggplot2</code> package).</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">landsat_colors_1230</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">3</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre>
</div>
<p>That throws an error as sometimes plotRGB doesn’t like really large
values when it rescales. RGB values for a computer screen are typically
between 0 and 255, so, we just need to rescale our values between 0 and
255. We can do that by multiplying the raster values by 255/(max of the
raster values). Note, you can either do this so EACH channel is
rescalled to 0-255, or, they are all rescaled by one grand value.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colmax</span> <span class="op">&lt;-</span> <span class="fu">max</span><span class="op">(</span><span class="va">landsat_colors_1230</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">values</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">max</span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">colmax</span></span>
<span>    </span>
<span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">landsat_colors_1230</span> <span class="op">*</span> <span class="fl">255</span><span class="op">/</span><span class="va">colmax</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">3</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">1</span>, main <span class="op">=</span> <span class="st">"Rescaled for each channel"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-plot-rgb-scaled-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The image above looks OK, but dark. You can actually play with the
denominator of the scaling to make more interesting ones, or scale by
other rasters. But, there are more standard (and better) stretching
algorithms. We can explore whether applying a stretch to the image might
improve clarity and contrast using <code>stretch="lin"</code> or
<code>stretch="hist"</code>.</p>
<p>When the range of pixel brightness values is closer to 0, a darker
image is rendered by default. We can stretch the values to extend to the
full 0-255 range of potential values to increase the visual contrast of
the image.</p>
<figure><img src="fig/dc-spatial-raster/imageStretch_dark.jpg" alt="Image Stretch" class="figure mx-auto d-block"></figure><p>When the range of pixel brightness values is closer to 255, a lighter
image is rendered by default. We can stretch the values to extend to the
full 0-255 range of potential values to increase the visual contrast of
the image.</p>
<figure><img src="fig/dc-spatial-raster/imageStretch_light.jpg" alt="Image Stretch light" class="figure mx-auto d-block"></figure><p>We can implement this easily in R where we not only make a linear
stretch, but chop off some of the highest and lowest values.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">landsat_colors_1230</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">1</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-plot-rgb-lin-stretch-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>If the problem is that we want an even distribution of values for
each channel, rather than clumps and clusters, we use <code>hist</code>
as our stretch.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">landsat_colors_1230</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">1</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        stretch <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-plot-rbg-image-linear-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>In this case, the stretch begins to show some things happening
offshore a bit more, which might prompt more investigation.</p>
<p>Note, to do this with ggplot2, we need to apply
<code>stretch()</code> to the raster first and cut off the lower and
upper quantile of values. We can then use
<code>geom_spatraster_rgb()</code>. Note, to use <code>stretch()</code>
and get the RGB right, we need to reference the layer numbers of the
raster as indices.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster_rgb</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">stretch</span><span class="op">(</span><span class="va">landsat_colors_1230</span><span class="op">[[</span><span class="fu">c</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                                 minq <span class="op">=</span> <span class="fl">0.02</span>, maxq <span class="op">=</span> <span class="fl">0.98</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-geom_spatraster_rgb-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge---false-color-images" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge---false-color-images" class="callout-inner">
<h3 class="callout-title">Challenge - False Color Images<a class="anchor" aria-label="anchor" href="#challenge---false-color-images"></a>
</h3>
<div class="callout-content">
<p>What we have plotted above is a True Color Image. To help see things,
many people use False color Images. Either they switch the bands (so,
GRB instead of RGB) or use other bands. What do you see that is
different if you try the following. Apply any stretch you like.</p>
<ol style="list-style-type: decimal">
<li>Instead of RGB, plot GRB.<br>
</li>
<li>Instead of RBG, plot NRG (where N = NIR). This creates a ‘vegetation
in red’ map, which can be useful for vegetation.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Answers</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>Note how we use r, g, and b as channel 1, 2, and 3.</li>
</ol>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">landsat_colors_1230</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">2</span>, g <span class="op">=</span> <span class="fl">3</span>, b <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span></span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Here if you stretch with hist,you can get a better split between
very vegetated and urbanized areas.</li>
</ol>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">landsat_colors_1230</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">4</span>, g <span class="op">=</span> <span class="fl">3</span>, b <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        stretch <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="data-tip-1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip-1" class="callout-inner">
<h3 class="callout-title">Data Tip<a class="anchor" aria-label="anchor" href="#data-tip-1"></a>
</h3>
<div class="callout-content">
<p>You can create interactive RGB overlays as well. But it takes some
extra doing, as you have to downsample large images, as
<code>geom_spatraster()</code> does natively. You can do this with
<code>spatSample()</code>. <code>leaflet</code> currently does odd
things to RGB rasters, so, you should use the <code>leafem</code>
library. Which does not yet handle <code>SpatRaster</code> objects from
<code>terra</code>. Fortunately, it’s a small thing to convert it to an
old school <code>raster</code> stack with <code>raster::stack()</code>
(we’re not loading the whole library to prevent conflicts in function
names). Note, for big rasters, you can up <code>maxbytes</code> in the
<code>addRasterRGB</code> from it’s default of <code>4*1024*1024</code>,
but, this can cause plotting to take a very very very long time.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">leafem</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># resample and then convert to a raster::stack object</span></span>
<span><span class="co"># note, if this raster was small, we wouldn't have to </span></span>
<span><span class="co"># spatSample()</span></span>
<span><span class="va">landsat_colors_raster</span> <span class="op">&lt;-</span> <span class="va">landsat_colors_1230</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">spatSample</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5e5</span>, as.raster <span class="op">=</span> <span class="cn">TRUE</span>, method <span class="op">=</span> <span class="st">"regular"</span><span class="op">)</span><span class="op">|&gt;</span> </span>
<span>  <span class="fu">raster</span><span class="fu">::</span><span class="fu">stack</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot using addRasterRGB from leafem</span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterRGB</span><span class="op">(</span>x <span class="op">=</span> <span class="va">landsat_colors_raster</span>,</span>
<span>               quantiles <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.98</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>A single raster file can contain multiple bands or layers.</li>
<li>Use the <code>rast()</code> function to load all bands in a
multi-layer raster file into R.</li>
<li>Individual bands within a SpatRaster can be accessed, analyzed, and
visualized using the same functions no matter how many bands it
holds.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-04-raster-calculations-in-r"><p>Content from <a href="04-raster-calculations-in-r.html">Raster Calculations</a></p>
<hr>
<p>Last updated on 2024-01-10 |
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/episodes/04-raster-calculations-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I do math on rasters and extract pixel values for defined
locations?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Perform a math with different raster layers.</li>
<li>Perform more math using the raster <code>lapp()</code>
function.</li>
<li>Export raster data as a GeoTIFF file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This
Episode<a class="anchor" aria-label="anchor" href="#things-youll-need-to-complete-this-episode"></a>
</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
<p>You will also need some <a href="https://figshare.com/ndownloader/files/43988577" class="external-link">new data</a> that
you should unzip and put into the <code>data/landsat_casco</code>
folder.</p>
</div>
</div>
</div>
<p>We often want to combine values of and perform calculations on
rasters to create a new output raster. This episode covers how to
subtract one raster from another using basic raster math and the
<code>lapp()</code> function. It also covers how to extract pixel values
from a set of locations - for example a buffer region around plot
locations at a field site.</p>
<section id="raster-calculations-in-r"><h2 class="section-heading">Raster Calculations in R<a class="anchor" aria-label="anchor" href="#raster-calculations-in-r"></a>
</h2>
<hr class="half-width">
<p>We often want to perform calculations on two or more rasters to
create a new output raster. For example, if we are interested in getting
the observed chlorophyll in the water, we might want to use different
Landsat layers to calculate an observed value based on published
equations. This can help us identify Suberged Aquatic Vegetation (SAV).
The resulting data set might show us where seagrass or other vegetation
exists. There are two method for this we will use today from Zhang 2023
and O’Reilly and Werdell in 2019. The first is a calculation of
chlorophyll based on three bands that cover different nm of the visible
spectrum.</p>
<figure><img src="fig/Visible-spectrum-400-700-nm.png" alt="" class="figure mx-auto d-block"><figcaption>the visible spectrum in nm</figcaption></figure><p>Recall from before that the first few bands of Landsat 8 cover the
following: - Band 1 Coastal Aerosol (430 - 450 nm) 30 m - Band 2 Blue
(450 - 510 nm) 30 m - Band 3 Green (530 - 590 nm) 30 m - Band 4 Red (640
- 670 nm) 30 m - Band 5 Near-Infrared (850 - 880 nm) 30 m</p>
<p>To calculate Chla in the water, we will use imagery from Landsat that
has been algorithmically corrected for water - i.e., algorithms that
don’t just correct the imagery for things in the atmosphere, but that
literally try their best to correct for all of the spectral properties
of what is in the water. We are going to use three bands from a Landsat
scene in winter of 2023, as phytoplankton is at a low and we are more
likely to see what is on the seafloor. The imagery has been corrected
using <a href="https://odnature.naturalsciences.be/remsem/software-and-data/acolite" class="external-link">ACOLITE</a>.
With the three bands, in units of Rrs - in essence water leaving
irradiance / downwellign irradiance. To learn more, <a href="https://www.oceanopticsbook.info/view/inherent-and-apparent-optical-properties/reflectances" class="external-link">see
here</a>.</p>
<figure><img src="fig/chl_eqn.png" alt="" class="figure mx-auto d-block"><figcaption>chl eqn</figcaption></figure><p>Where those a coefficients come from <a href="https://www.earthdata.nasa.gov/apt/documents/chlor-a/v1.0#mathematical_theory" class="external-link">NASA
Algorithms</a>. Those three wavelengths correspond to the coastal band,
the green band, and the blue band.</p>
<p>The second method is a bit simpler. It’s called the Chlorophyll
Absorption Ratio Index (CARI).</p>
<p><img src="fig/cari.png" alt="CARI eqn" class="figure"> Let’s see how simple it is
to make these work for us!</p>
<div id="more-resources" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="more-resources" class="callout-inner">
<h3 class="callout-title">More Resources<a class="anchor" aria-label="anchor" href="#more-resources"></a>
</h3>
<div class="callout-content">
<ul>
<li><p><a href="https://www.earthdata.nasa.gov/apt/documents/chlor-a/v1.0#mathematical_theory" class="external-link">Chlorophyll
A algorithms</a> and NASA Earthdata.</p></li>
<li><p>O’Reilly, J. E., &amp; Werdell, P. J. (2019). Chlorophyll
algorithms for ocean color sensors-OC4, OC5 &amp; OC6. <a href="https://doi.org/10.1016/j.rse.2019.04.021" class="external-link">https://doi.org/10.1016/j.rse.2019.04.021</a></p></li>
</ul>
</div>
</div>
</div>
<div class="section level3">
<h3 id="load-libraries-and-pre-process-the-data">Load Libraries and Pre-Process the Data<a class="anchor" aria-label="anchor" href="#load-libraries-and-pre-process-the-data"></a>
</h3>
<figure><img src="data/landsat_casco/L8_OLI_2023_02_07_15_27_04_012030_L2R/L8_OLI_2023_02_07_15_27_04_012030_L2R_rgb_rhos.png" alt="" class="figure mx-auto d-block"><figcaption>New Hampshire and Southern Maine in Winter 2023</figcaption></figure><p>For this episode, we will use the Landsat scene from 2023 and the
seagrass beds from Casco Bay in 2022 (we’ll assume they’re close enough
to 2023). Let’s start by loading <code>terra</code>, <code>sf</code>,
and <code>ggplot2</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyterra</span><span class="op">)</span></span></code></pre>
</div>
<p>Next, let’s load our two different data sources. We will load the
rasters into one stack for ease of use. We will also load the Casco AOI
and Maine State borders for use in cropping and masking down to just
water.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#ACOLITE corrected Rrs</span></span>
<span><span class="va">landsat_files</span> <span class="op">&lt;-</span> <span class="fu">list.files</span><span class="op">(</span></span>
<span>  <span class="st">"data/landsat_casco/L8_OLI_2023_02_07_15_27_04_012030_L2R/"</span>,</span>
<span>           pattern <span class="op">=</span> <span class="st">"tif"</span>,</span>
<span>           full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we only want files 3 through 5 - coastal, blue, and green</span></span>
<span><span class="va">landsat_layers</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">landsat_files</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error: [rast] filename is empty. Provide a valid filename</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># give the layers better names</span></span>
<span><span class="fu">names</span><span class="op">(</span><span class="va">landsat_layers</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"blue_443"</span>, <span class="st">"blue_483"</span>, <span class="st">"green_561"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error: object 'landsat_layers' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load our shapefile</span></span>
<span><span class="va">seagrass_casco_2022</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_seagrass/MaineDEP_Casco_Bay_Seagrass_2022/MaineDEP_Casco_Bay_Seagrass_2022.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load files for processing</span></span>
<span><span class="va">aoi_boundary_casco</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/casco_aoi/casco_bay_aoi.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">maine_borders</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/maine_gov_maps/Maine_State_Boundary_Polygon_Feature/Maine_State_Boundary_Polygon_Feature.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div id="exercise" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise" class="callout-inner">
<h3 class="callout-title">Exercise<a class="anchor" aria-label="anchor" href="#exercise"></a>
</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>Look at the information about the Landsat raster and shapefiles.
Are they similar or different?</p></li>
<li><p>If we want to just look at the Casco Bay region of the Landsat
data, what types of spatial operations will we have to execute to make
this work?</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="fu">sources</span><span class="op">(</span><span class="va">landsat_layers</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'describe': error in evaluating the argument 'x' in selecting a method for function 'sources': object 'landsat_layers' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco_2022</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Simple feature collection with 622 features and 15 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -70.24464 ymin: 43.57213 xmax: -69.84399 ymax: 43.93221
Geodetic CRS:  WGS 84
First 10 features:
   OBJECTID Id Name       Acres   Hectares Orth_Cover Cover_Pct Field_Ver
1         1  1   01  0.04456005 0.01803281          1      0-10         Y
2         2  4   02  0.06076669 0.02459141          3     40-70         Y
3         3  6   03  2.56218247 1.03687846          3     40-70         Y
4         4  8   05  0.71816162 0.29062970          3     40-70         Y
5         5  9   06  0.01815022 0.00734513          3     40-70         Y
6         6 10   07  0.33051475 0.13375458          3     40-70         Y
7         7 11   08  0.08088664 0.03273366          1      0-10         Y
8         8 13   09  0.66689055 0.26988103          1      0-10         Y
9         9 14   10  0.03080650 0.01246695          3     40-70         Y
10       10 15   11 12.54074080 5.07505774          4    70-100         Y
   Video_YN                          Video Comment        Species
1         Y                            A03    &lt;NA&gt; Zostera marina
2         Y                            A04    &lt;NA&gt; Zostera marina
3         Y                            A05    &lt;NA&gt; Zostera marina
4         Y                            A07    &lt;NA&gt; Zostera marina
5         Y                            A08    &lt;NA&gt; Zostera marina
6         Y                            A09    &lt;NA&gt; Zostera marina
7         Y                            A10    &lt;NA&gt; Zostera marina
8         Y                            A11    &lt;NA&gt; Zostera marina
9         Y                            A12    &lt;NA&gt; Zostera marina
10        Y A14, A15, A16, A17, SP07, SP08    &lt;NA&gt; Zostera marina
                                 GlobalID  ShapeSTAre ShapeSTLen
1  {7CAB9D54-4BF9-4B91-94D6-4F0EA4AD53C1}   180.32842  102.57257
2  {D5396F39-D508-45CB-BFE0-13A506D4E94C}   245.91500   84.35420
3  {3C1ED4DC-6580-4CAC-9499-32D445019068} 10368.78375  719.04025
4  {6C1395B8-F532-46C6-AFBA-23B14C2F2E02}  2906.29561  315.88722
5  {EDEDAFA1-8605-4FAC-910F-E6E864F51209}    73.45108   34.00204
6  {820DE3B5-BA6E-4415-A110-95F9F94A4F1C}  1337.54527  165.98655
7  {E4E2A155-7B1C-46C3-94B5-6D0E58B1FEBB}   327.33664  112.52478
8  {C7FEF8AC-9BA7-429C-A45B-270E836FBBA1}  2698.81099  295.01388
9  {356C58A4-DB72-445F-83DA-1035C8EAE917}   124.66947   43.47523
10 {C797140E-F9CB-4EA0-9D7C-FBEA50FE9EB2} 50750.58217 1949.02908
                         geometry
1  POLYGON ((-70.20081 43.5722...
2  POLYGON ((-70.20228 43.5869...
3  POLYGON ((-70.20858 43.5909...
4  POLYGON ((-70.21488 43.5924...
5  POLYGON ((-70.21499 43.5931...
6  POLYGON ((-70.21582 43.5963...
7  POLYGON ((-70.21618 43.5964...
8  POLYGON ((-70.21641 43.5971...
9  POLYGON ((-70.21498 43.6063...
10 POLYGON ((-70.22445 43.6425...</code></pre>
</div>
<p>Different in CRS and extent. We will have to project and crop.</p>
</div>
</div>
</div>
</div>
<p>So, we have to get Landsat into the same CRS as our Maine data. We
will then have to crop it down to the Casco region. This is actually one
of those cases where it will be faster to reproject the vectors than the
raster for the cropping.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aoi_boundary_casco_projected</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">aoi_boundary_casco</span>,</span>
<span>                                             <span class="fu">crs</span><span class="op">(</span><span class="va">landsat_layers</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'crs': object 'landsat_layers' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_layers_casco</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span><span class="va">landsat_layers</span>,</span>
<span>                             <span class="va">aoi_boundary_casco_projected</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'crop': object 'landsat_layers' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_layers_casco</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">landsat_layers_casco</span>, </span>
<span>                                <span class="fu">crs</span><span class="op">(</span><span class="va">seagrass_casco_2022</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'project': object 'landsat_layers_casco' not found</code></pre>
</div>
</div>
</section><section id="masking-out-land-with-a-vector"><h2 class="section-heading">Masking Out Land with a Vector<a class="anchor" aria-label="anchor" href="#masking-out-land-with-a-vector"></a>
</h2>
<hr class="half-width">
<p>Let’s see what we have after the cropping.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">landsat_layers_casco</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greys"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'landsat_layers_casco' not found</code></pre>
</div>
<p>This is neat, but…… it’s dominated by the land. We want to mask the
land. Otherwise, the signal is going to be dominated by land and not
sea. Fortunately, we can use the coastline of the state from the maine
shapefile with <code>mask()</code>. By default, mask keeps what is IN
polygons. So we will need to use the argument
<code>inverse = TRUE</code>. We also need our coastline to have the same
extent as our raster, so, we’ll need to crop it first.</p>
<p>We will also recrop to the AOI again, as our previous crop leaves
some cruft around the edges.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">casco_coastline</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">maine_borders</span> <span class="op">|&gt;</span> <span class="fu">st_make_valid</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                           <span class="va">aoi_boundary_casco</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># mask and crop</span></span>
<span><span class="va">landsat_layers_casco_bay</span> <span class="op">&lt;-</span> <span class="fu">mask</span><span class="op">(</span><span class="va">landsat_layers_casco</span>,</span>
<span>                                 <span class="va">casco_coastline</span>,</span>
<span>                                 inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">crop</span><span class="op">(</span><span class="va">aoi_boundary_casco</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'crop': error in evaluating the argument 'x' in selecting a method for function 'mask': object 'landsat_layers_casco' not found</code></pre>
</div>
<p>Did it blend?</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">landsat_layers_casco_bay</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Greys"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'landsat_layers_casco_bay' not found</code></pre>
</div>
<p>This looks great. There are still some really really high and low
values. We might want to figure out a threshold for clamping. Looking at
the histogram below, something like 0.02 for the upper seems reasonable.
We will use <code>values=FALSE</code> to just remove very high values
and make them NA.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hist</span><span class="op">(</span><span class="va">landsat_layers_casco_bay</span>, breaks <span class="op">=</span> <span class="fl">100</span>, xlim <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.02</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'hist': object 'landsat_layers_casco_bay' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landsat_layers_casco_bay</span> <span class="op">&lt;-</span> <span class="fu">clamp</span><span class="op">(</span><span class="va">landsat_layers_casco_bay</span>,</span>
<span>                                   lower <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                   upper <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>                                   value <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'clamp': object 'landsat_layers_casco_bay' not found</code></pre>
</div>
<p>Replot it, and, wow, you can really start to see some variability</p>
</section><section id="two-ways-to-perform-raster-calculations"><h2 class="section-heading">Two Ways to Perform Raster Calculations<a class="anchor" aria-label="anchor" href="#two-ways-to-perform-raster-calculations"></a>
</h2>
<hr class="half-width">
<p>We can calculate with rasters in two different ways:</p>
<ul>
<li>by directly using the rasters in R using raster math</li>
</ul>
<p>or for more efficient processing - particularly if our rasters are
large and/or the calculations we are performing are complex:</p>
<ul>
<li>using the <code>lapp()</code> function.</li>
</ul></section><section id="raster-math-cari"><h2 class="section-heading">Raster Math &amp; CARI<a class="anchor" aria-label="anchor" href="#raster-math-cari"></a>
</h2>
<hr class="half-width">
<p>We can perform raster calculations by subtracting (or adding,
multiplying, etc) two rasters. In the geospatial world, we call this
“raster math”.</p>
<p>Let’s calculate (green - blue)/(green + blue) to get our CARI score.
After doing this, let’s plot with <code>ggplot</code>.</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">casco_cari</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">landsat_layers_casco_bay</span><span class="op">$</span><span class="va">green_561</span> <span class="op">-</span> <span class="va">landsat_layers_casco_bay</span><span class="op">$</span><span class="va">blue_483</span><span class="op">)</span> <span class="op">/</span></span>
<span>  <span class="op">(</span><span class="va">landsat_layers_casco_bay</span><span class="op">$</span><span class="va">green_561</span> <span class="op">+</span> <span class="va">landsat_layers_casco_bay</span><span class="op">$</span><span class="va">blue_483</span><span class="op">)</span> </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'landsat_layers_casco_bay' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">casco_cari</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"CARI"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error: object 'casco_cari' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_cari</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"CARI"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'casco_cari' not found</code></pre>
</div>
<p>Let’s have a look at the distribution of values in our newly created
CARI Model (CHM).</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hist</span><span class="op">(</span><span class="va">casco_cari</span>,</span>
<span>     maxcell <span class="op">=</span> <span class="fu">ncell</span><span class="op">(</span><span class="va">casco_cari</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'hist': object 'casco_cari' not found</code></pre>
</div>
<p>We are definitely starting to see some coastal features here,
although whether it is chlorophyll or just coastal runoff is
unclear.</p>
<div id="challenge-explore-chm-raster-values" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-explore-chm-raster-values" class="callout-inner">
<h3 class="callout-title">Challenge: Explore CHM Raster Values<a class="anchor" aria-label="anchor" href="#challenge-explore-chm-raster-values"></a>
</h3>
<div class="callout-content">
<p>It’s often a good idea to explore the range of values in a raster
dataset just like we might explore a dataset that we collected in the
field. Or the spatial distribution to see if it lines up with
expectations.</p>
<ol style="list-style-type: decimal">
<li><p>Zoom in on an island (Mackworth if you like). What does the
spatial distribution look like? Use <code>ggplot2</code> or
<code>leaflet</code>.</p></li>
<li><p>Overlay the seagrass bed shapefile. What do you see?</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Answers</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>Zooming in, some of the highest values are close to shorelines.</li>
</ol>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span>x <span class="op">=</span> <span class="va">casco_cari</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'casco_cari' not found</code></pre>
</div>
<ol start="2" style="list-style-type: decimal"><li>
</li></ol>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">colorNumeric</span><span class="op">(</span><span class="st">"viridis"</span>, <span class="fu">values</span><span class="op">(</span><span class="va">casco_cari</span><span class="op">)</span>, na.color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'values': object 'casco_cari' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span>x <span class="op">=</span> <span class="va">casco_cari</span>,</span>
<span>                 colors <span class="op">=</span> <span class="va">pal</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>,</span>
<span>               color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>               weight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addLegend</span><span class="op">(</span>pal <span class="op">=</span> <span class="va">pal</span>, values <span class="op">=</span> <span class="fu">values</span><span class="op">(</span><span class="va">casco_cari</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'values': object 'casco_cari' not found</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="efficient-raster-calculations"><h2 class="section-heading">Efficient Raster Calculations<a class="anchor" aria-label="anchor" href="#efficient-raster-calculations"></a>
</h2>
<hr class="half-width">
<p>Raster math, like we just did, is an appropriate approach to raster
calculations if:</p>
<ol style="list-style-type: decimal">
<li>The rasters we are using are small in size.</li>
<li>The calculations we are performing are simple.</li>
</ol>
<p>However, raster math is a less efficient approach as computation
becomes more complex or as file sizes become large.</p>
<p>The <code>lapp()</code> function takes two or more rasters and
applies a function to them using efficient processing methods. The
syntax is</p>
<p><code>outputRaster &lt;- lapp(x, fun=functionName)</code></p>
<p>In which raster can be either a SpatRaster or a SpatRasterDataset
which is an object that holds rasters. See <code>help(sds)</code>.</p>
<p>If you have a raster, stack, you can instead use
<code>app()</code></p>
<p><code>outputRaster &lt;- app(x, fun=functionName)</code></p>
<div id="data-tip" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip<a class="anchor" aria-label="anchor" href="#data-tip"></a>
</h3>
<div class="callout-content">
<p>To create a SpatRasterDataset, we call the function <code>sds</code>
which can take a list of raster objects (each one created by calling
<code>rast</code>).</p>
</div>
</div>
</div>
<p>Let’s perform the chla calculation that we calculated above using
raster math, using the <code>app()</code> function.</p>
<div id="data-tip-1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip-1" class="callout-inner">
<h3 class="callout-title">Data Tip<a class="anchor" aria-label="anchor" href="#data-tip-1"></a>
</h3>
<div class="callout-content">
<p>A custom function consists of a defined set of commands performed on
a input object. Custom functions are particularly useful for tasks that
need to be repeated over and over in the code. A simplified syntax for
writing a custom function in R is:
<code>function_name &lt;- function(variable1, variable2) { WhatYouWantDone, WhatToReturn}</code></p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_chl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">rast_stack</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">#eqn 3.1</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">log10</span><span class="op">(</span><span class="fu">max</span><span class="op">(</span><span class="va">rast_stack</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">rast_stack</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">rast_stack</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#eqn 3.2</span></span>
<span>  <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="fl">0.30963</span> <span class="op">+</span> <span class="op">-</span><span class="fl">2.40052</span><span class="op">*</span><span class="va">x</span> <span class="op">+</span> <span class="fl">1.28932</span><span class="op">*</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">0.52802</span><span class="op">*</span><span class="va">x</span><span class="op">^</span><span class="fl">3</span> <span class="op">+</span> <span class="op">-</span><span class="fl">1.33825</span><span class="op">*</span><span class="va">x</span><span class="op">^</span><span class="fl">4</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">casco_chla</span> <span class="op">&lt;-</span> <span class="fu">app</span><span class="op">(</span><span class="va">landsat_layers_casco_bay</span>, </span>
<span>                    fun <span class="op">=</span> <span class="va">get_chl</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'app': object 'landsat_layers_casco_bay' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">casco_chla</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"chla"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error: object 'casco_chla' not found</code></pre>
</div>
<p>Now we can plot the CHLa:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">casco_chla</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Chl a"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'casco_chla' not found</code></pre>
</div>
<p>How do the plots of the CHM created with manual raster math and the
<code>lapp()</code> function compare?</p>
<div id="challenge-explore-chm-raster-values-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-explore-chm-raster-values-1" class="callout-inner">
<h3 class="callout-title">Challenge: Explore CHM Raster Values<a class="anchor" aria-label="anchor" href="#challenge-explore-chm-raster-values-1"></a>
</h3>
<div class="callout-content">
<p>How does Chla compare to CARI? Check it out with
<code>leaflet()</code></p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Show me the solution</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>Qualitatively, they look about the same!</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pal_chl</span> <span class="op">&lt;-</span> <span class="fu">colorNumeric</span><span class="op">(</span><span class="st">"viridis"</span>, <span class="fu">values</span><span class="op">(</span><span class="va">casco_chla</span><span class="op">)</span>, na.color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'values': object 'casco_chla' not found</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb49">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addRasterImage</span><span class="op">(</span>x <span class="op">=</span> <span class="va">casco_chla</span>,</span>
<span>                 colors <span class="op">=</span> <span class="va">pal_chl</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">seagrass_casco_2022</span>,</span>
<span>               color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>               weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>              fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addLegend</span><span class="op">(</span>pal <span class="op">=</span> <span class="va">pal_chl</span>, values <span class="op">=</span> <span class="fu">values</span><span class="op">(</span><span class="va">casco_chla</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'values': object 'casco_chla' not found</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="export-a-geotiff"><h2 class="section-heading">Export a GeoTIFF<a class="anchor" aria-label="anchor" href="#export-a-geotiff"></a>
</h2>
<hr class="half-width">
<p>Now that we’ve created a new raster, let’s export the data as a
GeoTIFF file using the <code>writeRaster()</code> function.</p>
<p>When we write this raster object to a GeoTIFF file we’ll name it
<code>casco_cari.tif</code>. This name allows us to quickly remember
both what the data contains (CARI data) and for where (Casco bay). The
<code>writeRaster()</code> function by default writes the output file to
your working directory unless you specify a full file path.</p>
<p>We will specify the output format (“GTiff”), the no data value
<code>NAflag = -9999</code>. We will also tell R to overwrite any data
that is already in a file of the same name.</p>
<div class="codewrapper sourceCode" id="cb51">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">writeRaster</span><span class="op">(</span><span class="va">casco_cari</span>, <span class="st">"data/casco_cari.tif"</span>,</span>
<span>            filetype<span class="op">=</span><span class="st">"GTiff"</span>,</span>
<span>            overwrite<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>            NAflag<span class="op">=</span><span class="op">-</span><span class="fl">9999</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="writeraster-options">writeRaster() Options<a class="anchor" aria-label="anchor" href="#writeraster-options"></a>
</h3>
<p>The function arguments that we used above include:</p>
<ul>
<li>
<strong>filetype:</strong> specify that the format will be
<code>GTiff</code> or GeoTIFF.</li>
<li>
<strong>overwrite:</strong> If TRUE, R will overwrite any existing
file with the same name in the specified directory. USE THIS SETTING
WITH CAUTION!</li>
<li>
<strong>NAflag:</strong> set the GeoTIFF tag for
<code>NoDataValue</code> to -9999, the National Ecological Observatory
Network’s (NEON) standard <code>NoDataValue</code>.</li>
</ul>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Rasters can be computed on using mathematical functions.</li>
<li>The <code>lapp()</code> and <code>app()</code> function provides an
efficient way to do raster math.</li>
<li>The <code>writeRaster()</code> function can be used to write raster
data to a file.</li>
</ul>
</div>
</div>
</div>
</div>
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/" class="external-link">Source</a></p>
				<p><a href="https://github.com/cobalt-casco/r-raster-vector-geospatial/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:jarrett.byrnes@umb.edu">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.2" class="external-link">sandpaper (0.16.2)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.3" class="external-link">pegboard (0.7.3)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.1" class="external-link">varnish (1.0.1)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://cobalt-casco.github.io/r-raster-vector-geospatial/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries, Casco Bay, seagrass",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://cobalt-casco.github.io/r-raster-vector-geospatial/aio.html",
  "identifier": "https://cobalt-casco.github.io/r-raster-vector-geospatial/aio.html",
  "dateCreated": "2023-11-05",
  "dateModified": "2024-01-10",
  "datePublished": "2024-01-10"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

